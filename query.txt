  SELECT CURRENT_TIMESTAMP(0);


   SELECT CURRENT_TIMESTAMP(0);


CREATE VOLATILE TABLE V_CUST_SERV_TIME_RANGE_DLY AS (
SEL  
Trim(TIM.YR_NUM) AS SALE_TKT_YR,
LPad(Trim(TIM.CALDR_DTPRD3_IN_YR_NUM), 2, '0') AS SALE_TKT_PD, 
Trim(TIM.CALDR_WK_IN_DTPRD3_NUM) AS SALE_TKT_WK, 
TIM.DAY_DT AS SALE_TKT_DLY_DT,
Trim(TIM.YR_NUM)||LPad(Trim(TIM.CALDR_DTPRD3_IN_YR_NUM), 2, '0')||Trim(TIM.CALDR_WK_IN_DTPRD3_NUM) AS SALE_TKT_FL_WK_DT,
TIM.CALDR_WK_STRT_DT AS WK_START_DT,
TIMFRM.TMFRM_NUM,
Case when TIMFRM.TMFRM_NUM in (4,20,21) then 'HTFRAME' else 'FTFRAME' end as TIME_FLAG
FROM DWL_P.DW_PEP_CALDR_DT TIM
INNER JOIN DWL_P.DW_TMSLC_CUR_REF_DT TIMFRM ON 
TIM.DAY_DT = TIMFRM.CALDR_DT
AND TMFRM_NUM IN (4, 20, 21, 136, 123) 
WHERE TIM.CALDR_ID = 11
AND TIM.DAY_DT> '2020-01-01' 
) WITH DATA
PRIMARY INDEX (SALE_TKT_DLY_DT)
ON COMMIT PRESERVE ROWS;


COLLECT STATISTICS COLUMN (SALE_TKT_YR ,SALE_TKT_PD ,SALE_TKT_WK ,SALE_TKT_FL_WK_DT ,WK_START_DT) ON V_CUST_SERV_TIME_RANGE_DLY;


COLLECT STATISTICS COLUMN (SALE_TKT_DLY_DT) ON V_CUST_SERV_TIME_RANGE_DLY;


COLLECT STATISTICS COLUMN (SALE_TKT_YR) ON V_CUST_SERV_TIME_RANGE_DLY;


COLLECT STATISTICS COLUMN (SALE_TKT_YR ,SALE_TKT_PD ,SALE_TKT_WK ,WK_START_DT) ON V_CUST_SERV_TIME_RANGE_DLY;


COLLECT STATISTICS COLUMN (WK_START_DT) ON V_CUST_SERV_TIME_RANGE_DLY;


CREATE VOLATILE TABLE V_CUST_SERV_CUST AS (
SEL 
CUST.DW_CUST_ID, 
Trim(CUST.CUST_ID) AS CUST_ID,
CUST.XREF_DW_CUST_ID,
CUST.XREF_CUST_ID, 
CASE WHEN Trim(CUST.PRMRY_CUST_ID) = Trim(CUST.CUST_ID) THEN 1 ELSE 0 END AS PRMRY_CUST_FLG,
CASE WHEN PRMRY_CUST_FLG = 0 AND CUST.PGT_CHAIN_LVL_6_ID IS NOT NULL 
 AND CUST.PGT_CHAIN_LVL_6_ID = SACCT.PARM_ATRBT1_VAL THEN 1 ELSE 0 END AS SUB_ACCT_FLG,
CASE WHEN ELIG.RT_TYPE_CODE IS NULL THEN 1 ELSE 0 END AS RTTYPE_ELIG_FLG,
CASE WHEN (PRMRY_CUST_FLG=1 OR SUB_ACCT_FLG=1) AND RTTYPE_ELIG_FLG=1 THEN 'Y' ELSE 'N' END AS SERV_CUST_FLG,
CUST.CUST_STTS_CDV AS CUST_STAT_CODE, 
CUST.LVL_5_SLS_UNIT_ID AS LVL1_NODE_NBR, 
CUST.LVL_4_SLS_UNIT_ID AS LVL2_NODE_NBR,
CUST.LVL_3_SLS_UNIT_ID AS LVL3_NODE_NBR,
CUST.LVL_2_SLS_UNIT_ID AS LVL4_NODE_NBR,          
CUST.LVL_4_SLS_UNIT_ID AS GEO_LVL2_KEY, -- Pulling direct data for Region
CUST.LVL_3_SLS_UNIT_ID AS GEO_LVL3_KEY, -- Pulling direct data for Zone
CUST.LVL_2_SLS_UNIT_ID AS GEO_LVL4_KEY, -- Pulling direct data for District
CUST.GEO_TYP_CDV,
CUST.PGT_CHAIN_LVL_6_ID,
CUST.TRADE_CHANL_FMT,
BUS.RTE_ID,
BUS.RTE_TYP_CDV,
TIM.SALE_TKT_DLY_DT AS DAY_DT,
TIM.WK_START_DT              
FROM DWL_P.DW_CUST_RPRTNG_ATRBT CUST 
INNER JOIN DWL_P.PGT_FLNA_BUS_REORG BUS ON
BUS.DW_CUST_ID = CUST.DW_CUST_ID
INNER JOIN V_CUST_SERV_TIME_RANGE_DLY TIM 
ON BUS.DAY_DT = TIM.SALE_TKT_DLY_DT
LEFT OUTER JOIN ACQ_P.MINP_PGT_CUST_SERV_RT_TYPE_CATEG_ASSIGN ELIG ON
ELIG.RT_TYPE_CODE = TRIM(BUS.RTE_TYP_CDV)
AND ELIG.RT_TYPE_CATEG_CODE = 'PSINELIG'
AND ELIG.SLS_ORG_CDV = 'US29'  
LEFT OUTER JOIN DWL_P.DW_DATA_PARM_ATRBT_VAL SACCT ON 
CUST.PGT_CHAIN_LVL_6_ID = SACCT.PARM_ATRBT1_VAL
AND SACCT.PARM_ID = 4
AND SACCT.PARM_ATRBT2_VAL = 'SUB ACCT'
AND SACCT.SYS_ID = 702
AND SACCT.CTRY_CDV = 'US' 
AND SACCT.CO_CDV = 'US29'
WHERE 
NOT (CUST.CUST_DSPLY_NM LIKE ANY ('%MIS%CAS%', '%SAFETY STOCK%','%NEW CUSTOMER%'))
AND CUST.CUST_DSPLY_NM <> 'CASH' and 
CUST.SYS_ID = 627
AND CUST.GEO_TYP_CDV IN ('RTL')
AND CUST.SLS_ORG_CDV = 'US29' 
) WITH DATA
PRIMARY INDEX (DW_CUST_ID,DAY_DT)
ON COMMIT PRESERVE ROWS;


COLLECT STATISTICS COLUMN (DW_CUST_ID ,CUST_ID ,SERV_CUST_FLG ,LVL1_NODE_NBR ,LVL2_NODE_NBR ,LVL3_NODE_NBR , RTE_ID) ON V_CUST_SERV_CUST;


COLLECT STATISTICS COLUMN (DW_CUST_ID,DAY_DT) ON V_CUST_SERV_CUST;


COLLECT STATISTICS COLUMN (DW_CUST_ID) ON V_CUST_SERV_CUST;


CREATE VOLATILE TABLE V_CUST_DLY_VISITPLAN AS (
SEL DISTINCT 
CDSD.XREF_DW_CUST_ID AS DW_CUST_ID, 
CDSD.XREF_CUST_ID as CUST_ID,
CDSD.CUST_VISTSCHD_DT AS SERV_DELIV_DLY_DT,
TIM.WK_START_DT,
TIM.SALE_TKT_YR,
TIM.SALE_TKT_PD,
TIM.SALE_TKT_WK,
TIM.SALE_TKT_FL_WK_DT,
C.LVL1_NODE_NBR,
C.LVL2_NODE_NBR,
C.LVL3_NODE_NBR,
C.LVL4_NODE_NBR,     
C.GEO_LVL2_KEY,
C.GEO_LVL3_KEY,
C.GEO_LVL4_KEY,
C.RTE_ID,
1 AS RECOM_PROD_DELIV_CALL_QTY,
C.SERV_CUST_FLG 
FROM DWL_P.DW_CUST_VISTSCHD_DAY_PLANACTY CDSD
INNER JOIN V_CUST_SERV_TIME_RANGE_DLY TIM ON 
CDSD.CUST_VISTSCHD_DT = TIM.SALE_TKT_DLY_DT
INNER JOIN V_CUST_SERV_CUST C ON
C.DW_CUST_ID = CDSD.XREF_DW_CUST_ID
AND C.DAY_DT = CDSD.CUST_VISTSCHD_DT
WHERE CDSD.VIST_ACTVTY1_CDV = 'D' 
AND CDSD.VIST_ACTVTY1_CNT > 0 and CDSD.GTMU_ID IN (5,799) 
) WITH DATA 
PRIMARY INDEX (DW_CUST_ID, SERV_DELIV_DLY_DT) 
ON COMMIT PRESERVE ROWS;


COLLECT STATISTICS COLUMN (DW_CUST_ID ,SERV_DELIV_DLY_DT) ON V_CUST_DLY_VISITPLAN;


CREATE VOLATILE TABLE V_CUST_DLY_SLS AS (
SEL DISTINCT 
C.CUST_ID,
C.DW_CUST_ID, 
TIM.SALE_TKT_DLY_DT AS INVC_DT, 
TIM.WK_START_DT,
TIM.SALE_TKT_YR,
TIM.SALE_TKT_PD,
TIM.SALE_TKT_WK,
TIM.SALE_TKT_FL_WK_DT,
C.LVL1_NODE_NBR,
C.LVL2_NODE_NBR,
C.LVL3_NODE_NBR,
C.LVL4_NODE_NBR,     
C.GEO_LVL2_KEY,
C.GEO_LVL3_KEY,
C.GEO_LVL4_KEY,
C.RTE_ID,
C.SERV_CUST_FLG,
Sum(CASE WHEN S.DW_SLS_ACTVTY_CDV = 'SLS' THEN S.WHLSL_AMT ELSE 0 END) AS SLS_AMT,
Sum(CASE WHEN S.DW_SLS_ACTVTY_CDV = 'RTRN' THEN S.WHLSL_AMT * (-1) ELSE 0 END) AS RTRN_AMT,
CASE WHEN (SLS_AMT + RTRN_AMT) = 0 THEN 0 ELSE 1 END AS ACTL_PROD_DELIV_CALL_QTY
FROM DWL_P.DW_SLS S 
INNER JOIN V_CUST_SERV_TIME_RANGE_DLY TIM ON 
S.INVC_DT = TIM.SALE_TKT_DLY_DT
Inner JOIN V_CUST_SERV_CUST C ON
C.DW_CUST_ID = S.XREF_DW_CUST_ID
AND C.DAY_DT = S.INVC_DT
WHERE S.CRSS_DK_DLVRY_FLG = 'N' and S.cru_id = 46 
AND S.GTMU_ID=799
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17
HAVING ACTL_PROD_DELIV_CALL_QTY = 1
) WITH DATA 
PRIMARY INDEX (DW_CUST_ID, INVC_DT) 
ON COMMIT PRESERVE ROWS;


COLLECT STATISTICS COLUMN (DW_CUST_ID ,INVC_DT) ON V_CUST_DLY_SLS;


CREATE VOLATILE TABLE V_CUST_SERV_DAILY AS (
SEL Coalesce(VP.DW_CUST_ID, SLS.DW_CUST_ID) AS DW_CUST_ID,
Coalesce(VP.CUST_ID, SLS.CUST_ID) AS CUST_ID,
Coalesce(VP.SERV_DELIV_DLY_DT, SLS.INVC_DT) AS DAY_DT,
Coalesce(VP.WK_START_DT, SLS.WK_START_DT) AS WK_STRT_DT,
Coalesce(VP.SALE_TKT_YR, SLS.SALE_TKT_YR) AS SALE_TKT_YR,
Coalesce(VP.SALE_TKT_FL_WK_DT, SLS.SALE_TKT_FL_WK_DT) AS SALE_TKT_FL_WK_DT,
Coalesce(VP.LVL1_NODE_NBR, SLS.LVL1_NODE_NBR) AS LVL1_NODE_NBR,
Coalesce(VP.LVL2_NODE_NBR, SLS.LVL2_NODE_NBR) AS LVL2_NODE_NBR,
Coalesce(VP.LVL3_NODE_NBR, SLS.LVL3_NODE_NBR) AS LVL3_NODE_NBR,
Coalesce(VP.LVL4_NODE_NBR, SLS.LVL4_NODE_NBR) AS LVL4_NODE_NBR,                      
Coalesce(VP.GEO_LVL2_KEY, SLS.GEO_LVL2_KEY) AS GEO_LVL2_KEY,
Coalesce(VP.GEO_LVL3_KEY, SLS.GEO_LVL3_KEY) AS GEO_LVL3_KEY,
Coalesce(VP.GEO_LVL4_KEY, SLS.GEO_LVL4_KEY) AS GEO_LVL4_KEY,
Coalesce(VP.RTE_ID, SLS.RTE_ID) AS RTE_ID,
Coalesce(VP.RECOM_PROD_DELIV_CALL_QTY, 0) AS RECOM_CALL_QTY, 
Coalesce(SLS.ACTL_PROD_DELIV_CALL_QTY, 0) AS ACTL_CALL_QTY,
Coalesce(VP.SERV_CUST_FLG, SLS.SERV_CUST_FLG) AS SERV_CUST_RSN_FLG,
CASE WHEN SERV_CUST_RSN_FLG = 'Y' AND RECOM_CALL_QTY = 1 THEN 'Y' ELSE 'N' END AS SAS_CUST_FLG,
CASE WHEN SAS_CUST_FLG = 'Y' THEN RECOM_CALL_QTY ELSE 0 END AS RCMNDD_CALL_SAS_QTY,
CASE WHEN SAS_CUST_FLG = 'Y' AND RECOM_CALL_QTY = 1 AND ACTL_CALL_QTY = 1 THEN 1 ELSE 0 END AS ACTL_CALL_SAS_QTY,
CASE WHEN SAS_CUST_FLG = 'Y' AND RECOM_CALL_QTY > 0 AND RCMNDD_CALL_SAS_QTY > ACTL_CALL_QTY 
 THEN RCMNDD_CALL_SAS_QTY - ACTL_CALL_QTY 
 ELSE 0 END AS ACTL_MISSD_CALL_QTY,
CASE WHEN SERV_CUST_RSN_FLG = 'Y' THEN 'ELIG_C' ELSE '' END AS SAS_RSN_CDV
FROM V_CUST_DLY_VISITPLAN VP 
FULL OUTER JOIN V_CUST_DLY_SLS SLS ON
SLS.DW_CUST_ID = VP.DW_CUST_ID 
AND SLS.INVC_DT = VP.SERV_DELIV_DLY_DT 
) WITH DATA
PRIMARY INDEX(DW_CUST_ID, DAY_DT)
ON COMMIT PRESERVE ROWS;


COLLECT STATISTICS COLUMN (WK_STRT_DT ,SALE_TKT_YR ,SALE_TKT_FL_WK_DT ,LVL1_NODE_NBR ,LVL2_NODE_NBR ,LVL3_NODE_NBR ,RTE_ID) ON V_CUST_SERV_DAILY;


COLLECT STATISTICS COLUMN (WK_STRT_DT) ON V_CUST_SERV_DAILY;


COLLECT STATISTICS COLUMN (SAS_CUST_FLG) ON V_CUST_SERV_DAILY;


CREATE VOLATILE TABLE V_CUST_SERV_DAILY_MINP AS (
SELECT
DLY.DW_CUST_ID,
DLY.CUST_ID,
DLY.DAY_DT,
DLY.WK_STRT_DT,
DLY.SALE_TKT_YR,
DLY.SALE_TKT_FL_WK_DT,
DLY.LVL1_NODE_NBR,
DLY.LVL2_NODE_NBR,
DLY.LVL3_NODE_NBR,
DLY.LVL4_NODE_NBR,       
DLY.RTE_ID,
CL.PARM_ATRBT1_VAL AS EXCL_LVL_INDC,            
DLY.RECOM_CALL_QTY, 
DLY.ACTL_CALL_QTY,
DLY.SERV_CUST_RSN_FLG,
DLY.SAS_CUST_FLG,
DLY.RCMNDD_CALL_SAS_QTY,
DLY.ACTL_CALL_SAS_QTY,
DLY.ACTL_MISSD_CALL_QTY,
DLY.SAS_RSN_CDV,
CASE WHEN MANL_EXCL.GEO_LVL_KEY IS NOT NULL THEN 1 ELSE 0 END AS MINP_EXCL_FLG
FROM V_CUST_SERV_DAILY AS DLY
LEFT OUTER JOIN ACQ_P.MINP_PGT_CUST_SERV_GEO_EXCL AS MANL_EXCL
ON MANL_EXCL.WK_STRT_DT = DLY.WK_STRT_DT
AND Trim(MANL_EXCL.GEO_LVL_KEY) = (CASE 
 WHEN MANL_EXCL.GEO_LVL_INDC = 1 THEN Trim(DLY.LVL1_NODE_NBR)
 WHEN MANL_EXCL.GEO_LVL_INDC = 2 THEN Trim(DLY.GEO_LVL2_KEY) 
 WHEN MANL_EXCL.GEO_LVL_INDC = 3 THEN Trim(DLY.GEO_LVL3_KEY) 
 WHEN MANL_EXCL.GEO_LVL_INDC = 4 THEN Trim(DLY.GEO_LVL4_KEY) 
 WHEN MANL_EXCL.GEO_LVL_INDC = 5 THEN Trim(DLY.RTE_ID)
 WHEN MANL_EXCL.GEO_LVL_INDC = 6 THEN Trim(DLY.CUST_ID)                     
 END)
AND MANL_EXCL.STATUS = 'ACTIVE'
INNER  JOIN DWL_P.DW_DATA_PARM_ATRBT_VAL CL ON 
 DLY.WK_STRT_DT BETWEEN Cast(CL.PARM_ATRBT2_VAL as date) AND Cast(CL.PARM_ATRBT3_VAL as date)  AND
CL.PARM_ID = 39
AND CL.SYS_ID = 702
AND CL.CO_CDV = 'US29'             
) WITH DATA
PRIMARY INDEX(DW_CUST_ID, DAY_DT)
ON COMMIT PRESERVE ROWS;


COLLECT STATISTICS COLUMN (WK_STRT_DT ,SALE_TKT_YR ,SALE_TKT_FL_WK_DT ,LVL1_NODE_NBR ,LVL2_NODE_NBR ,LVL3_NODE_NBR ,RTE_ID) ON V_CUST_SERV_DAILY_MINP;


COLLECT STATISTICS COLUMN (WK_STRT_DT) ON V_CUST_SERV_DAILY_MINP;


COLLECT STATISTICS COLUMN (SAS_CUST_FLG) ON V_CUST_SERV_DAILY_MINP;


CREATE VOLATILE TABLE V_CUST_SERV_GEO_WKLY_AGGRD_MINP AS (
SEL 
CL.PARM_ATRBT1_VAL AS EXCL_LVL_INDC ,
CASE 
 WHEN CL.PARM_ATRBT1_VAL = '1' THEN M.LVL1_NODE_NBR
 WHEN CL.PARM_ATRBT1_VAL = '2' THEN M.LVL2_NODE_NBR
 WHEN CL.PARM_ATRBT1_VAL = '3' THEN M.LVL3_NODE_NBR
 WHEN CL.PARM_ATRBT1_VAL = '4' THEN M.LVL4_NODE_NBR
 WHEN CL.PARM_ATRBT1_VAL = '5' THEN M.RTE_ID  
    WHEN CL.PARM_ATRBT1_VAL = '6' THEN M.CUST_ID
 END AS GEO_LVL_KEY ,
WK_STRT_DT,
SALE_TKT_YR,
SALE_TKT_FL_WK_DT,
Sum(RCMNDD_CALL_SAS_QTY) AS RCMNDD_CALL_SAS_QTY, 
Sum(ACTL_CALL_SAS_QTY) AS ACTL_CALL_SAS_QTY
FROM V_CUST_SERV_DAILY_MINP M
INNER JOIN DWL_P.DW_DATA_PARM_ATRBT_VAL CL ON 
CL.PARM_ID = 39
AND CL.SYS_ID = 702
AND CL.CO_CDV = 'US29'            
WHERE SAS_CUST_FLG = 'Y'
AND MINP_EXCL_FLG = 0
AND M.WK_STRT_DT BETWEEN Cast(CL.PARM_ATRBT2_VAL as date) AND Cast(CL.PARM_ATRBT3_VAL as date)                             
GROUP BY 1,2,3,4,5
) WITH DATA
PRIMARY INDEX(GEO_LVL_KEY, WK_STRT_DT) 
ON COMMIT PRESERVE ROWS;


COLLECT STATISTICS COLUMN (GEO_LVL_KEY ,SALE_TKT_YR) ON V_CUST_SERV_GEO_WKLY_AGGRD_MINP;


COLLECT STATISTICS COLUMN (SALE_TKT_YR) ON V_CUST_SERV_GEO_WKLY_AGGRD_MINP;


CREATE VOLATILE TABLE V_CUST_SERV_GEO_WK_SAS_PCT_RANK AS (
SEL 
EXCL_LVL_INDC,
GEO_LVL_KEY,     
D.SALE_TKT_FL_WK_DT,
D.WK_STRT_DT, 
C.EXCLD_CNT,
Coalesce(Cast(ACTL_CALL_SAS_QTY AS DECIMAL (18,4)) / Cast(NullIf(RCMNDD_CALL_SAS_QTY,0) AS DECIMAL (18, 4)), 0.0000)  AS SAS_PCT,
Row_Number() Over  (PARTITION BY D.GEO_LVL_KEY, D.SALE_TKT_YR ORDER BY SAS_PCT ASC, D.WK_STRT_DT ASC) AS GEO_WK_SAS_PCT_ROW
FROM V_CUST_SERV_GEO_WKLY_AGGRD_MINP D
INNER JOIN (
 SEL SALE_TKT_YR, 
 Max(CNTS) AS EXCLD_CNT
 FROM (
  SEL SALE_TKT_YR, 
  SALE_TKT_PD,
  SALE_TKT_WK,
  WK_START_DT, 
  Row_Number ()  Over (PARTITION BY  SALE_TKT_YR ORDER BY WK_START_DT ASC) AS WK_IN_YR_NBR,
  Cast (WK_IN_YR_NBR/4 AS DECIMAL (2,0)) AS CNTS
  FROM V_CUST_SERV_TIME_RANGE_DLY
  where TIME_FLAG = 'HTFRAME'
  GROUP BY 1,2,3,4
 ) EXCLD_WK_CNT
 GROUP BY 1
) C ON
C.SALE_TKT_YR = D.SALE_TKT_YR
where WK_STRT_DT in (select wk_start_dt from V_CUST_SERV_TIME_RANGE_DLY where TIME_FLAG = 'HTFRAME')
) WITH DATA
PRIMARY INDEX (GEO_LVL_KEY, WK_STRT_DT)
ON COMMIT PRESERVE ROWS;


COLLECT STATISTICS COLUMN (GEO_WK_SAS_PCT_ROW ,EXCLD_CNT) ON V_CUST_SERV_GEO_WK_SAS_PCT_RANK;


COLLECT STATISTICS COLUMN (GEO_LVL_KEY ,WK_STRT_DT) ON V_CUST_SERV_GEO_WK_SAS_PCT_RANK;


CREATE VOLATILE TABLE V_RPRT_CUST_SERV_DAILY AS (
SEL D.DW_CUST_ID,
D.CUST_ID,
D.DAY_DT,
D.RTE_ID,
D.RECOM_CALL_QTY, 
D.ACTL_CALL_QTY,
D.RCMNDD_CALL_SAS_QTY,
D.ACTL_CALL_SAS_QTY,
D.ACTL_MISSD_CALL_QTY,
D.SAS_CUST_FLG,
CASE WHEN D.SAS_CUST_FLG = 'Y' AND S.GEO_LVL_KEY IS NOT NULL THEN 'ELIG_C 1'--D.SAS_RSN_CDV||' '||1 
 ELSE D.SAS_RSN_CDV END AS SAS_RSN_CDV,
CASE WHEN D.SAS_CUST_FLG = 'Y' AND S.GEO_LVL_KEY IS NOT NULL THEN 0 ELSE D.RCMNDD_CALL_SAS_QTY END AS RPRT_RCMNDD_CALL_SAS_QTY,
CASE WHEN D.SAS_CUST_FLG = 'Y' AND S.GEO_LVL_KEY IS NOT NULL THEN 0 ELSE D.ACTL_CALL_SAS_QTY END AS RPRT_ACTL_DLVRY_CALL_SAS_QTY
FROM V_CUST_SERV_DAILY_MINP D 
LEFT OUTER JOIN V_CUST_SERV_GEO_WK_SAS_PCT_RANK S ON
CASE 
 WHEN D.EXCL_LVL_INDC = '1' THEN  TRIM(D.LVL1_NODE_NBR)
 WHEN D.EXCL_LVL_INDC = '2' THEN  TRIM(D.LVL2_NODE_NBR)
 WHEN D.EXCL_LVL_INDC = '3' THEN  TRIM(D.LVL3_NODE_NBR)
 WHEN D.EXCL_LVL_INDC = '4' THEN  TRIM(D.LVL4_NODE_NBR)
 WHEN D.EXCL_LVL_INDC = '5' THEN  TRIM(D.RTE_ID)
    WHEN D.EXCL_LVL_INDC = '6' THEN  TRIM(D.CUST_ID)
 END =S. GEO_LVL_KEY  
AND S.WK_STRT_DT = D.WK_STRT_DT
AND S.GEO_WK_SAS_PCT_ROW <= EXCLD_CNT
WHERE D.MINP_EXCL_FLG = 0
UNION ALL
SEL D.DW_CUST_ID,
D.CUST_ID,
D.DAY_DT,
D.RTE_ID,
D.RECOM_CALL_QTY, 
D.ACTL_CALL_QTY,
D.RCMNDD_CALL_SAS_QTY,
D.ACTL_CALL_SAS_QTY,
D.ACTL_MISSD_CALL_QTY,
D.SAS_CUST_FLG,
CASE WHEN D.SAS_CUST_FLG = 'Y' THEN 'ELIG_C 2'--D.SAS_RSN_CDV||' '||2
 ELSE D.SAS_RSN_CDV END AS SAS_RSN_CDV,
CASE WHEN D.SAS_CUST_FLG = 'Y' THEN 0 ELSE D.RCMNDD_CALL_SAS_QTY END AS RPRT_RCMNDD_CALL_SAS_QTY,
CASE WHEN D.SAS_CUST_FLG = 'Y' THEN 0 ELSE D.ACTL_CALL_SAS_QTY END AS RPRT_ACTL_DLVRY_CALL_SAS_QTY
FROM V_CUST_SERV_DAILY_MINP D 
WHERE D.MINP_EXCL_FLG = 1
) WITH DATA
PRIMARY INDEX (DW_CUST_ID, DAY_DT)
ON COMMIT PRESERVE ROWS;


CREATE VOLATILE TABLE V_DELIV_NM AS (
SEL VIST_ACTVTY1_CDV, VIST_ACTVTY1_NM, Max(CUST_VISTSCHD_DT) MAX_DT
FROM DWL_P.DW_CUST_VISTSCHD_DAY_PLANACTY
WHERE VIST_ACTVTY1_CDV = 'D' and GTMU_ID IN (5,799)
GROUP BY 1,2
) WITH DATA ON COMMIT PRESERVE ROWS;


CREATE MULTISET VOLATILE TABLE V_CUST_FINAL AS (
SELECT 
C.DW_CUST_ID,
46 AS CRU_ID,
C.CUST_ID,
C.DAY_DT,
D.VIST_ACTVTY1_CDV AS CUST_VIST_ACTVTY_CDV,
D.VIST_ACTVTY1_NM AS CUST_VIST_ACTVTY_NM,
'US' AS CTRY_CDV, 
'US29' AS CO_CDV,
C.RECOM_CALL_QTY, 
C.ACTL_CALL_QTY,
CASE WHEN dt.time_flag = 'HTFRAME' THEN C.RCMNDD_CALL_SAS_QTY ELSE C.RPRT_RCMNDD_CALL_SAS_QTY END AS rcmndd_call_sas_qty,
CASE WHEN dt.time_flag = 'HTFRAME' THEN C.ACTL_CALL_SAS_QTY ELSE C.RPRT_ACTL_DLVRY_CALL_SAS_QTY END AS actl_dlvry_call_sas_qty, 
case when c.day_dt <= current_date-1 THEN C.ACTL_MISSD_CALL_QTY ELSE 0 END AS actl_missd_call_qty ,
C.SAS_CUST_FLG,
C.SAS_RSN_CDV,
'500' AS CLNT_ID,
'A1P' AS ZSYSID,
'GMP' AS ACQ_PGT_SYS_ID,
'62735' AS ACQ_MDM_SYS_ID,  
CURRENT_TIMESTAMP(0) AS ACQ_LAST_UPDT_DTM,
'US29' AS SLS_ORG_CDV,
C.RPRT_RCMNDD_CALL_SAS_QTY AS RPRT_RCMNDD_CALL_SAS_QTY,
C.RPRT_ACTL_DLVRY_CALL_SAS_QTY AS RPRT_ACTL_DLVRY_CALL_SAS_QTY,
'Y' as CUST_FLAG -- Added as part of customer exclusion													   
FROM V_RPRT_CUST_SERV_DAILY C 
INNER JOIN V_DELIV_NM D ON 1=1
LEFT OUTER JOIN V_CUST_SERV_TIME_RANGE_DLY Dt
    ON c.day_dt=dt.SALE_TKT_DLY_DT
) WITH DATA ON COMMIT PRESERVE ROWS
;


CREATE VOLATILE TABLE V_CUST_EXCLUSION as 
(
select A.cust_id,A.dw_cust_id, 
CASE WHEN CL.PARM_ATRBT1_VAL IS NULL THEN 'Y' ELSE 'N' END AS CUST_LIST_FLG 
from V_CUST_FINAL  A inner join DWL_P.DW_CUST_RPRTNG_ATRBT B   on A.dw_cust_id = B.dw_cust_id
left outer join DWL_P.DW_DATA_PARM_ATRBT_VAL CL  on  B.CUST_ID = CL.PARM_ATRBT1_VAL
AND CL.PARM_ID = 37
AND CL.SYS_ID = 702
AND CL.CTRY_CDV = 'US'
AND CL.CO_CDV = 'US29'
and   A.DAY_DT >= Cast(CL.PARM_ATRBT2_VAL as date)
 AND  A.DAY_DT <= Cast(CL.PARM_ATRBT3_VAL as date)
)WITH DATA ON COMMIT PRESERVE ROWS;


UPDATE TGT
FROM V_CUST_FINAL TGT, (SEL DISTINCT DW_CUST_ID FROM  DWL_P.DW_CUST_RPRTNG_ATRBT 
WHERE  SYS_ID ='627' AND CTRY_CDV='US' ) B  
, (SEL DISTINCT DW_CUST_ID,CUST_LIST_FLG FROM  V_CUST_EXCLUSION) C  
SET CUST_FLAG = C.CUST_LIST_FLG
WHERE TGT.DW_CUST_ID = B.DW_CUST_ID
and B.DW_CUST_ID = C.DW_CUST_ID ;


UPDATE TGT
FROM V_CUST_FINAL TGT, DWL_P.DW_CUST_RPRTNG_ATRBT B  
, DWL_P.DW_DATA_PARM_ATRBT_VAL C  
SET RCMNDD_CALL_SAS_QTY = 0,
  ACTL_DLVRY_CALL_SAS_QTY = 0,
  RPRT_RCMNDD_CALL_SAS_QTY = 0,
  RPRT_ACTL_DLVRY_CALL_SAS_QTY = 0,
    SAS_RSN_CDV = 'ELIG_C 3'
WHERE TGT.DW_CUST_ID = B.DW_CUST_ID
and B.PGT_CHAIN_LVL_6_ID = C.PARM_ATRBT1_VAL
and B.GEO_TYP_CDV = 'RTL'
  AND B.SLS_ORG_CDV = 'US29'
  AND B.SYS_ID = '627' 
  AND C.PARM_ID = 31
  AND C.SYS_ID = 702
  AND C.CTRY_CDV = 'US'
  AND C.CO_CDV = 'US29'
  AND TGT.DAY_DT >= Cast(C.PARM_ATRBT2_VAL AS DATE)
  AND TGT.DAY_DT <= Cast(C.PARM_ATRBT4_VAL AS DATE)
  AND TGT.SAS_CUST_FLG = 'Y';


 SELECT Current_Timestamp(0);


CREATE VOLATILE TABLE V_CUST_NEG_SLS AS (
SEL
S.XREF_DW_CUST_ID as DW_CUST_ID,
S.INVC_DT,
S.SLS_AMT,
S.SLS_RTRN_AMT,
S.TKT_SLS_AMT
FROM SEM_EXTRCT.DLS_FLNA_SLS_CUST_DLY_SUMMRY S
INNER JOIN V_CUST_FINAL SF ON
S.XREF_DW_CUST_ID = SF.DW_CUST_ID
AND S.INVC_DT = SF.DAY_DT
INNER JOIN DWL_P.DW_DATA_PARM_ATRBT_VAL PARM_TKT ON PARM_TKT.PARM_ID=35
INNER JOIN DWL_P.DW_DATA_PARM_ATRBT_VAL PARM_SLS ON PARM_SLS.PARM_ID=36
WHERE ((S.TKT_SLS_AMT BETWEEN Cast(PARM_TKT.PARM_ATRBT1_VAL AS DECIMAL(18,4)) AND Cast(PARM_TKT.PARM_ATRBT2_VAL AS DECIMAL(18,4)))
AND (SLS_AMT BETWEEN Cast(PARM_SLS.PARM_ATRBT1_VAL AS DECIMAL(18,4))AND Cast(PARM_SLS.PARM_ATRBT2_VAL AS DECIMAL(18,4))))
AND S.CRU_ID = 46  
) WITH DATA
UNIQUE PRIMARY INDEX(DW_CUST_ID,INVC_DT)
ON COMMIT PRESERVE ROWS;


UPDATE SD FROM
V_CUST_FINAL SD,
V_CUST_NEG_SLS NSLS
SET RPRT_ACTL_DLVRY_CALL_SAS_QTY = 0 
,SAS_RSN_CDV = 'ELIG_C 4'
WHERE SD.DW_CUST_ID = NSLS.dw_cust_id and
SD.DAY_DT = NSLS.invc_dt
AND SD.SAS_CUST_FLG = 'Y';


DELETE FROM DWL_P_FLNA.PGT_FLNA_GEO_WK_SAS_EXCPTN  WHERE WK_STRT_DT IN (SELECT WK_START_DT from V_CUST_SERV_TIME_RANGE_DLY)   ;


INSERT INTO DWL_P_FLNA.PGT_FLNA_GEO_WK_SAS_EXCPTN (
 GEO_LVL1_NODE_NBR,
 GEO_LVL2_NODE_NBR,
 GEO_LVL3_NODE_NBR,
        GEO_LVL_IND,
        GEO_LVL_KEY,
 SALE_TKT_FL_WK_DT,
 WK_STRT_DT,
 SAS_OVRL_CALL_PCT,
 ZN_WK_SAS_PERFMNC_RNK,
 CNT_EXCLDD_QTY,
 SYS_ID,
 DW_BTCH_ID,
 DW_STEP_ID,
 DW_CRTD_DTM,
 DW_UPDT_DTM
)
SELECT 
 ' ' AS LVL1_NODE_NBR, 
 ' ' AS LVL2_NODE_NBR,
 ' ' AS LVL3_NODE_NBR,
EXCL_LVL_INDC,
GEO_LVL_KEY,
 SALE_TKT_FL_WK_DT,
 WK_STRT_DT, 
 SAS_PCT,
 GEO_WK_SAS_PCT_ROW,
 EXCLD_CNT,
 627,
 mybtch_id,
 mystep_id,
 current_timestamp(0),
 current_timestamp(0)
FROM V_CUST_SERV_GEO_WK_SAS_PCT_RANK
LEFT OUTER JOIN
(
 SELECT 
  max(actvty.cur_btch_id) as mybtch_id
  , max(step.step_id) as mystep_id
 FROM PEPCMN_P.STEP
 INNER JOIN PEPCMN_P.ACTVTY
 ON actvty.actvty_id = step.actvty_id
 INNER JOIN PEPCMN_P.SYS
 ON sys.sys_nm = actvty.sys_nm
 WHERE
 SYS.SYS_NM ='DWL' AND
 ACTVTY_NM = 'LD_DWL_PGT_CUST_SERV' AND
 STEP_NM = 'DWL_PGT_FLNA_LOAD_CUST_SRVC_DAILY'
) THIS_STEP ON 1=1 
;


 SELECT CURRENT_TIMESTAMP(0);


DELETE FROM DWL_P_DRVD.PGT_FLNA_CUST_VIST_ACTVTY_MEAS_DAILY 
WHERE day_dt in (
SELECT SALE_TKT_DLY_DT from V_CUST_SERV_TIME_RANGE_DLY)
AND CRU_ID = 46
AND CTRY_CDV = 'US'
;


 SELECT CURRENT_TIMESTAMP(0);


INSERT INTO DWL_P_DRVD.PGT_FLNA_CUST_VIST_ACTVTY_MEAS_DAILY (  
 dw_cust_id                    
 , cru_id                        
 , cust_id 
 , day_dt                        
 , cust_vist_actvty_cdv          
 , cust_vist_actvty_nm           
 , ctry_cdv                      
 , co_cdv                        
 , recom_call_qty                
 , actl_call_qty                 
 , rcmndd_call_sas_qty           
 , actl_dlvry_call_sas_qty       
 , actl_missd_call_qty           
 , sas_cust_flg                  
 , sas_rsn_cdv
 ,CLNT_ID
 ,ZSYSID                    
 ,ACQ_PGT_SYS_ID
 ,ACQ_MDM_SYS_ID
 ,ACQ_LAST_UPDT_DTM
 ,SLS_ORG_CDV
 , dw_btch_id                    
 , dw_step_id                    
 , dw_crtd_dtm                   
 , dw_updt_dtm    
    , RPRT_RCMNDD_CALL_SAS_QTY    
    , RPRT_ACTL_DLVRY_CALL_SAS_QTY    
)
SELECT 
DW_CUST_ID,
CRU_ID,
CUST_ID,
DAY_DT,
CUST_VIST_ACTVTY_CDV,
CUST_VIST_ACTVTY_NM,
CTRY_CDV, 
CO_CDV,
RECOM_CALL_QTY, 
ACTL_CALL_QTY,
rcmndd_call_sas_qty,
actl_dlvry_call_sas_qty, 
actl_missd_call_qty ,
SAS_CUST_FLG,
SAS_RSN_CDV,
CLNT_ID,
ZSYSID,
ACQ_PGT_SYS_ID,
ACQ_MDM_SYS_ID,  
ACQ_LAST_UPDT_DTM,
SLS_ORG_CDV,
mystep_id,
mybtch_id,
Current_Timestamp(0),
Current_Timestamp(0),
RPRT_RCMNDD_CALL_SAS_QTY,
RPRT_ACTL_DLVRY_CALL_SAS_QTY
 FROM V_CUST_FINAL
LEFT OUTER JOIN
(
 SELECT 
  max(actvty.cur_btch_id) as mybtch_id
  , max(step.step_id) as mystep_id
 FROM PEPCMN_P.STEP
 INNER JOIN PEPCMN_P.ACTVTY
 ON actvty.actvty_id = step.actvty_id
 INNER JOIN PEPCMN_P.SYS
 ON sys.sys_nm = actvty.sys_nm
 WHERE
 SYS.SYS_NM ='DWL' AND
 ACTVTY_NM = 'LD_DWL_PGT_CUST_SERV' AND
 STEP_NM = 'DWL_PGT_FLNA_LOAD_CUST_SRVC_DAILY'
) THIS_STEP ON 1=1 
WHERE CUST_FLAG = 'Y'      
;


 SELECT CURRENT_TIMESTAMP(0);


UPDATE TGT 
from DWL_P_DRVD.PGT_FLNA_CUST_VIST_ACTVTY_MEAS_DAILY TGT, V_CUST_SERV_CUST CUST_XREF
SET
    XREF_CUST_ID = CUST_XREF.XREF_CUST_ID,
    XREF_DW_CUST_ID = CUST_XREF.XREF_DW_CUST_ID 
    WHERE TGT.CUST_ID = CUST_XREF.CUST_ID
 AND TGT.DAY_DT = CUST_XREF.DAY_DT
    ;


COLLECT STATISTICS ON DWL_P_FLNA.FLNA_GEO_WK_SAS_EXCPTN;


COLLECT STATISTICS ON DWL_P_DRVD.PGT_FLNA_CUST_VIST_ACTVTY_MEAS_DAILY;


 SELECT CURRENT_TIMESTAMP(0);


  SELECT CURRENT_TIMESTAMP(0);

