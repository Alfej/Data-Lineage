20250807-055418::PEPCMN

BTEQ 16.20.00.10 (64-bit) Thu Aug  7 05:54:18 2025 PID: 20744
 
+---------+---------+---------+---------+---------+---------+---------+----

  .run file /etlapps/prds2/dwl/intl/bin/dwl_intl_tdlogon.btq
+---------+---------+---------+---------+---------+---------+---------+----
.logon tdprod/DWL_BATCH_INTL_P,

 *** Logon successfully completed.
 *** Teradata Database Release is 17.20.03.16a                  
 *** Teradata Database Version is 17.20.03.16                     
 *** Transaction Semantics are BTET.
 *** Session Character Set Name is 'ASCII'.
 
 *** Total elapsed time was 11 seconds.
 
+---------+---------+---------+---------+---------+---------+---------+----

 *** Encountered EOF on RUN file. Returning to stdin.
+---------+---------+---------+---------+---------+---------+---------+----
  .IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+----

  .set width 254
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
  .set maxerror 4
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

  SELECT CURRENT_TIMESTAMP(0);

 *** Query completed. One row found. One column returned. 
 *** Total elapsed time was 1 second.

     Current TimeStamp(0)
-------------------------
2025-08-07 05:54:29-05:00

+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
  
  EXEC PEPCMN_P.STEP_STRT('DWL', 'LD_PGT_FLNA_SLS_CUST_MTRL_SUMMRY', 'DW_PGT_FLNA_SLS_CUST_MTRL_SUMMRY_LOAD', '/etlapps/prds2/dwl/intl/logs/LD_PGT_FLNA_SLS_CUST_MTRL_SUMMRY_DW_PGT_FLNA_SLS_CUST_MTRL_SUMMRY_LOAD.log');

 *** Insert completed. One row added. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

  .IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

  .logoff;
 *** You are now logged off from the DBC.
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

  .quit;
 *** Exiting BTEQ...
 *** RC (return code) = 0 
Return Code 0
grep: /etlapps/prds2/dwl/intl/tmp/LD_PGT_FLNA_SLS_CUST_MTRL_SUMMRY.DW_PGT_FLNA_SLS_CUST_MTRL_SUMMRY_LOAD.DW_PGT_FLNA_CUST_MTRL_SUMMRY.wkf: No such file or directory
Executing load task
BTEQ 16.20.00.10 (64-bit) Thu Aug  7 05:54:29 2025 PID: 21289
 
+---------+---------+---------+---------+---------+---------+---------+----

  .RUN FILE /etlapps/prds2/dwl/intl/bin/dwl_intl_tdlogon.btq
+---------+---------+---------+---------+---------+---------+---------+----
.logon tdprod/DWL_BATCH_INTL_P,

 *** Logon successfully completed.
 *** Teradata Database Release is 17.20.03.16a                  
 *** Teradata Database Version is 17.20.03.16                     
 *** Transaction Semantics are BTET.
 *** Session Character Set Name is 'ASCII'.
 
 *** Total elapsed time was 11 seconds.
 
+---------+---------+---------+---------+---------+---------+---------+----

 *** Encountered EOF on RUN file. Returning to stdin.
+---------+---------+---------+---------+---------+---------+---------+----
  .IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+----

  .SET WIDTH 254
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
  .SET MAXERROR 4
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

   SELECT SESSION;

 *** Query completed. One row found. One column returned. 
 *** Total elapsed time was 1 second.

    Session
-----------
  101758731

+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
   SELECT CURRENT_TIMESTAMP(0);

 *** Query completed. One row found. One column returned. 
 *** Total elapsed time was 1 second.

     Current TimeStamp(0)
-------------------------
2025-08-07 05:54:40-05:00

+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

  .IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

CREATE MULTISET VOLATILE TABLE VT_DW_FLNA_SLS_CUST_STG
     (
      DW_CUST_ID BIGINT NOT NULL,
      INVC_DT DATE FORMAT 'YYYY-MM-DD' NOT NULL
      )
PRIMARY INDEX ( DW_CUST_ID ,INVC_DT )
ON COMMIT PRESERVE ROWS;

 *** Table has been created. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

CREATE MULTISET VOLATILE TABLE VT_FLNA_SLS_RESTAT
     (
      DW_CUST_ID BIGINT,
      DW_MTRL_ID BIGINT,
      INVC_DT DATE FORMAT 'YYYY-MM-DD'
      )
PRIMARY INDEX ( DW_CUST_ID ,DW_MTRL_ID ,INVC_DT )
ON COMMIT PRESERVE ROWS;

 *** Table has been created. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

CREATE MULTISET VOLATILE TABLE VT_FLNA_SLS_RESTAT_CA
     (
      DW_CUST_ID BIGINT,
      DW_MTRL_ID BIGINT,
      INVC_DT DATE FORMAT 'YYYY-MM-DD'
      )
PRIMARY INDEX ( DW_CUST_ID ,DW_MTRL_ID ,INVC_DT )
ON COMMIT PRESERVE ROWS;

 *** Table has been created. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

--Customer XREF VOLATILE
CREATE MULTISET VOLATILE TABLE XREF_CUST_VTBL
AS (
SELECT SCOLV1,SCOLV2,TCOLV1,TCOLV2,SCOLV3,COALESCE(TRIM(GTMU_ID),'-999') AS GTMU_ID FROM (
SELECT SCOLV1,SCOLV2,TCOLV1,TCOLV2,SCOLV3,SCOLV4
FROM ACQ_P.GTMD_DDH_ZGT_XREF_DAT SRC
WHERE SSYS='PGTMDG' AND  TSYS ='FLNAMF' AND XREFID = 'CUSTOMERNO' AND PGT_SYS_ID='GMP' AND MANDT='500'
QUALIFY ROW_NUMBER() OVER  (PARTITION BY SCOLV1,SCOLV2 ORDER BY DIH__PUBLICATION_INSTANCE_DATE DESC)=1 )XREF
LEFT JOIN
DWL_P.GTMU_CNTRL_ATRBT_TRNSPS_V GTMU
    ON XREF.SCOLV2 = GTMU.SLSORG_CDV AND XREF.SCOLV3 = GTMU.DSTRBTN_CHNL_CDV
    AND XREF.SCOLV4 = GTMU.BUSN_SGMNT_CDV AND GTMU.SYS_ID = 627 AND GTMU.CFV_SBJCT_CDV = '2'
) WITH DATA
PRIMARY INDEX(SCOLV1)
ON COMMIT PRESERVE ROWS;

 *** Table has been created. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

  -- BT;

 SELECT CURRENT_TIMESTAMP(0);

 *** Query completed. One row found. One column returned. 
 *** Total elapsed time was 1 second.

     Current TimeStamp(0)
-------------------------
2025-08-07 05:54:41-05:00

+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

 --- EXEC PEPCMN_P.DT_PRM_RESET2 ('DWL', 'LD_PGT_FLNA_SLS_CUST_MTRL_SUMMRY', 'DW_PGT_FLNA_SLS_CUST_MTRL_SUMMRY_LOAD', 0);

  .IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

  SET QUERY_BAND = 'ltype=dwl;ltask=load;ltbl=pgt_flna_sls_cust_mtrl_summry;' FOR TRANSACTION;

 *** Set QUERY_BAND accepted. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
  .IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

-- Loads transactional table from source
--   The related WIT# is 1


INSERT INTO VT_FLNA_SLS_RESTAT
(
DW_CUST_ID,
DW_MTRL_ID,
INVC_DT
)
SELECT
SLS.XREF_DW_CUST_ID AS DW_CUST_ID
,SLS.XREF_DW_MTRL_ID AS DW_MTRL_ID
,SLS.INVC_DT AS INVC_DT
FROM DWL_P.DW_SLS SLS
  LEFT OUTER JOIN
  (
    SELECT DT_PRM2.CTL_STRT_DTM, CTL_END_DTM
    FROM PEPCMN_P.DT_PRM2
    WHERE STEP_ID IN
    (
     SELECT STEP_ID
     FROM PEPCMN_P.STEP
     JOIN PEPCMN_P.ACTVTY
     ON ACTVTY.ACTVTY_ID = STEP.ACTVTY_ID AND SYS_NM = 'DWL' AND ACTVTY_NM = 'LD_PGT_FLNA_SLS_CUST_MTRL_SUMMRY'
     WHERE
     STEP_NM = 'DW_PGT_FLNA_SLS_CUST_MTRL_SUMMRY_LOAD'
    )
     AND SYS_ID = 0
   ) THIS_STEP_DATES ON 1=1
WHERE SLS.CRU_ID=46
AND SLS.SYS_ID=702
--AND SLS.INVC_DT IN('2024-02-25','2024-02-21','2024-02-23','2024-02-24')
--AND SLS.DW_UPDT_DTM >= COALESCE(CTL_STRT_DTM,CAST('1900-01-01 00:00:00' AS TIMESTAMP(0)))
--AND SLS.DW_UPDT_DTM <= COALESCE(CTL_END_DTM,CAST('1900-01-01 00:00:00' AS TIMESTAMP(0)))
AND SLS.DW_UPDT_DTM >= COALESCE(CTL_END_DTM,CAST('1900-01-01 00:00:00' AS TIMESTAMP(0)))

GROUP BY XREF_DW_CUST_ID,XREF_DW_MTRL_ID,INVC_DT;

 *** Insert completed. 3445185 rows added. 
 *** Total elapsed time was 41 seconds.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

  .IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

INSERT INTO VT_FLNA_SLS_RESTAT
(
DW_CUST_ID,
DW_MTRL_ID,
INVC_DT
)
SELECT
SLS.XREF_DW_CUST_ID AS DW_CUST_ID
,SLS.XREF_DW_MTRL_ID AS DW_MTRL_ID
,SLS.INVC_DT AS INVC_DT
FROM DWL_P.DW_SLS SLS
LEFT OUTER JOIN
(
    SELECT DT_PRM2.CTL_STRT_DTM, CTL_END_DTM
    FROM PEPCMN_P.DT_PRM2
    WHERE STEP_ID IN
    (
     SELECT STEP_ID
     FROM PEPCMN_P.STEP
     JOIN PEPCMN_P.ACTVTY
     ON ACTVTY.ACTVTY_ID = STEP.ACTVTY_ID AND SYS_NM = 'DWL' AND ACTVTY_NM = 'LD_PGT_FLNA_SLS_CUST_MTRL_SUMMRY'
     WHERE
     STEP_NM = 'DW_PGT_FLNA_SLS_CUST_MTRL_SUMMRY_LOAD'
    )
     AND SYS_ID = 0
) THIS_STEP_DATES ON 1=1
WHERE XREF_CUST_ID IN
(
SEL  DISTINCT PARM_ATRBT1_VAL FROM DWL_P_INTL.DW_DATA_PARM_ATRBT_VAL
WHERE PARM_ATRBT3_VAL ='NEW S4 CUSTOMER'
AND DW_UPDT_DTM >= COALESCE(CTL_END_DTM,CAST('1900-01-01 00:00:00' AS TIMESTAMP(0)))
)
AND SLS.CRU_ID=46
AND SLS.SYS_ID=702
AND SLS.INVC_DT>='2020-12-20'
GROUP BY XREF_DW_CUST_ID,XREF_DW_MTRL_ID,INVC_DT;

 *** Insert completed. 858 rows added. 
 *** Total elapsed time was one minute and 13 seconds.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-


.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

INSERT INTO VT_FLNA_SLS_RESTAT_CA
(
DW_CUST_ID,
DW_MTRL_ID,
INVC_DT
)
SELECT
SLS.XREF_DW_CUST_ID AS DW_CUST_ID
,SLS.XREF_DW_MTRL_ID AS DW_MTRL_ID
,SLS.INVC_DT AS INVC_DT
FROM DWL_P.DW_SLS SLS
  LEFT OUTER JOIN
  (
    SELECT DT_PRM2.CTL_STRT_DTM, CTL_END_DTM
    FROM PEPCMN_P.DT_PRM2
    WHERE STEP_ID IN
    (
     SELECT STEP_ID
     FROM PEPCMN_P.STEP
     JOIN PEPCMN_P.ACTVTY
     ON ACTVTY.ACTVTY_ID = STEP.ACTVTY_ID AND SYS_NM = 'DWL' AND ACTVTY_NM = 'LD_PGT_FLNA_SLS_CUST_MTRL_SUMMRY'
     WHERE
     STEP_NM = 'DW_PGT_FLNA_SLS_CUST_MTRL_SUMMRY_LOAD'
    )
     AND SYS_ID = 0
   ) THIS_STEP_DATES ON 1=1
WHERE SLS.CRU_ID=1
AND SLS.XREF_DW_CUST_ID IS NOT NULL
AND SLS.XREF_DW_MTRL_ID IS NOT NULL
AND SLS.DW_UPDT_DTM >= COALESCE(CTL_END_DTM,CAST('1900-01-01 00:00:00' AS TIMESTAMP(0)))
GROUP BY XREF_DW_CUST_ID,XREF_DW_MTRL_ID,INVC_DT;

 *** Insert completed. No rows added. 
 *** Total elapsed time was 14 seconds.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-


  .IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-


 SELECT CURRENT_TIMESTAMP(0);

 *** Query completed. One row found. One column returned. 
 *** Total elapsed time was 1 second.

     Current TimeStamp(0)
-------------------------
2025-08-07 05:56:49-05:00

+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

   DEL FROM DWL_P_DRVD_WORK.PGT_FLNA_SLS_CUST_GTMU_MTRL_SUMMRY_STG;

 *** Delete completed. 10226591 rows removed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

  .IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

/*******************POPULATE DATA FROM ACQ AND MDM TO STG IN DWL LAYER*****************/

INSERT INTO DWL_P_DRVD_WORK.PGT_FLNA_SLS_CUST_GTMU_MTRL_SUMMRY_STG

 ( DW_CUST_ID,
  DW_MTRL_ID,
  INVC_DT,
  CUST_ID,
  XREF_CUST_ID,
  XREF_DW_CUST_ID,
  MTRL_ID,
  XREF_MTRL_ID,
  XREF_DW_MTRL_ID,
  CRU_ID,
  SYS_ID,
  CTRY_ISO_CDV,
  CO_CDV,
  SLS_ORG_CDV,
  ESTMTD_SLS_CASE_QTY,
  SLS_EA_QTY,
  SLS_AMT,
  ESTMTD_SLS_RTRN_CASE_QTY,
  SLS_RTRN_EA_QTY,
  SLS_RTRN_AMT,
  ESTMTD_SLS_STL_CASE_QTY,
  SLS_STL_EA_QTY,
  SLS_STL_AMT,
  ESTMTD_SLS_DFECT_CASE_QTY,
  SLS_DFECT_EA_QTY,
  SLS_DFECT_AMT,
  ESTMTD_SLS_NET_SHPMT_CASE_QTY,
  SLS_NET_SHPMT_EA_QTY,
  SLS_NET_SHPMT_AMT,
  SLS_NDSCNT_AMT,
  ESTMTD_SLS_PRMTD_CASE_QTY,
  SLS_PRMTD_EA_QTY,
  SLS_PRMTD_AMT,
  ESTMTD_SLS_FULL_REV_CASE_QTY,
  SLS_FULL_REV_EA_QTY,
  SLS_FULL_REV_AMT,
  TOT_PRMTN_ALWNC_AMT,
  CNTRCTL_DSCNT_AMT,
  ESTMTD_TKT_SLS_CASE_QTY,
  TKT_SLS_EA_QTY,
  TKT_SLS_AMT,
  CRSS_DK_TKT_SLS_AMT,
  TKT_SLS_WT,
  TKT_SLS_RCLL_AMT,
  TKT_SLS_RCLL_CASE_QTY,
  TKT_SLS_RCLL_EA_QTY,
  TKT_SLS_RLLD_AMT,
  TKT_SLS_RLLD_CASE_QTY,
  TKT_SLS_RLLD_EA_QTY,
  CRSS_DK_TKT_SLS_CASE_QTY,
  CRSS_DK_TKT_SLS_EA_QTY,
  CRSS_DK_TKT_SLS_WT,
  ACQ_PGT_SYS_ID,
  ACQ_MDM_SYS_ID,
  MANDT,
  ZSYSID,
  DW_BTCH_ID,
  DW_STEP_ID,
  DW_CRTD_DTM,
  DW_UPDT_DTM,
  IUD_FLAG,
  GTMU_ID,
  CRSS_DK_TOT_PRMTN_ALWNC_AMT
  )
SELECT
DW_CUST_ID,
  DW_MTRL_ID,
  INVC_DT,
  CUST_ID,
  XREF_CUST_ID,
  XREF_DW_CUST_ID,
  MTRL_ID,
  XREF_MTRL_ID,
  XREF_DW_MTRL_ID,
  CRU_ID,
  SYS_ID,
  CTRY_ISO_CDV,
  CO_CDV,
  SLS_ORG_CDV,
  ESTMTD_SLS_CASE_QTY,
  SLS_EA_QTY,
  SLS_AMT,
  ESTMTD_SLS_RTRN_CASE_QTY,
  SLS_RTRN_EA_QTY,
  SLS_RTRN_AMT,
  ESTMTD_SLS_STL_CASE_QTY,
  SLS_STL_EA_QTY,
  SLS_STL_AMT,
  ESTMTD_SLS_DFECT_CASE_QTY,
  SLS_DFECT_EA_QTY,
  SLS_DFECT_AMT,
 COALESCE(ESTMTD_SLS_CASE_QTY,0) - COALESCE(ESTMTD_SLS_RTRN_CASE_QTY,0) AS ESTMTD_SLS_NET_SHPMT_CASE_QTY,
 COALESCE(SLS_EA_QTY,0) - COALESCE(SLS_RTRN_EA_QTY,0) AS SLS_NET_SHPMT_EA_QTY,
 (COALESCE(SLS_AMT,0) - COALESCE(SLS_RTRN_AMT,0)-COALESCE(TOT_PRMTN_ALWNC_AMT,0)) AS SLS_NET_SHPMT_AMT,
  SLS_NDSCNT_AMT,
  ESTMTD_SLS_PRMTD_CASE_QTY,
  SLS_PRMTD_EA_QTY,
  SLS_PRMTD_AMT,
  ESTMTD_SLS_FULL_REV_CASE_QTY,
  SLS_FULL_REV_EA_QTY,
  SLS_FULL_REV_AMT,
  TOT_PRMTN_ALWNC_AMT,
  CNTRCTL_DSCNT_AMT,
 (COALESCE(ESTMTD_SLS_CASE_QTY,0) - COALESCE(ESTMTD_SLS_RTRN_CASE_QTY,0)) AS  ESTMTD_TKT_SLS_CASE_QTY   ,
 (COALESCE(SLS_EA_QTY,0) - COALESCE(SLS_RTRN_EA_QTY,0)) AS  TKT_SLS_EA_QTY,
 (COALESCE(SLS_AMT,0) - COALESCE(SLS_RTRN_AMT,0)) AS TKT_SLS_AMT,
  CRSS_DK_TKT_SLS_AMT,
  TKT_SLS_WT,
  TKT_SLS_RCLL_AMT,
  TKT_SLS_RCLL_CASE_QTY,
  TKT_SLS_RCLL_EA_QTY,
  TKT_SLS_RLLD_AMT,
  TKT_SLS_RLLD_CASE_QTY,
  TKT_SLS_RLLD_EA_QTY,
  CRSS_DK_TKT_SLS_CASE_QTY,
  CRSS_DK_TKT_SLS_EA_QTY,
  CRSS_DK_TKT_SLS_WT,
  ACQ_PGT_SYS_ID,
  ACQ_MDM_SYS_ID,
  MANDT,
  ZSYSID,
  DW_BTCH_ID,
  DW_STEP_ID,
  DW_CRTD_DTM,
  DW_UPDT_DTM,
  IUD_FLAG,
  GTMU_ID,
  CRSS_DK_TOT_PRMTN_ALWNC_AMT
FROM (
SELECT
DW_CUST_ID,
DW_MTRL_ID,
INVC_DT,
CUST_ID,
XREF_CUST_ID,
XREF_DW_CUST_ID,
MTRL_ID,
XREF_MTRL_ID,
XREF_DW_MTRL_ID,
CRU_ID,
SYS_ID,
CTRY_ISO_CDV,
CO_CDV,
SLS_ORG_CDV,
SUM(ESTMTD_SLS_CASE_QTY) AS ESTMTD_SLS_CASE_QTY,
SUM(SLS_EA_QTY) AS SLS_EA_QTY,
SUM(SLS_AMT) AS SLS_AMT,
ABS(SUM(ESTMTD_SLS_RTRN_CASE_QTY)) AS ESTMTD_SLS_RTRN_CASE_QTY,
ABS(SUM(SLS_RTRN_EA_QTY)) AS SLS_RTRN_EA_QTY,
ABS(SUM(SLS_RTRN_AMT)) AS SLS_RTRN_AMT,
ABS(SUM(ESTMTD_SLS_STL_CASE_QTY)) AS ESTMTD_SLS_STL_CASE_QTY,
ABS(SUM(SLS_STL_EA_QTY)) AS SLS_STL_EA_QTY,
ABS(SUM(SLS_STL_AMT)) AS SLS_STL_AMT ,
ABS(SUM(ESTMTD_SLS_DFECT_CASE_QTY)) AS ESTMTD_SLS_DFECT_CASE_QTY,
ABS(SUM(SLS_DFECT_EA_QTY)) AS SLS_DFECT_EA_QTY,
ABS(SUM(SLS_DFECT_AMT)) AS SLS_DFECT_AMT,
/*SUM(ESTMTD_SLS_NET_SHPMT_CASE_QTY),
SUM(SLS_NET_SHPMT_EA_QTY),
SUM(SLS_NET_SHPMT_AMT),*/

SUM(SLS_NDSCNT_AMT) AS SLS_NDSCNT_AMT,
SUM(ESTMTD_SLS_PRMTD_CASE_QTY) AS ESTMTD_SLS_PRMTD_CASE_QTY,
SUM(SLS_PRMTD_EA_QTY) AS SLS_PRMTD_EA_QTY,
SUM(SLS_PRMTD_AMT) AS SLS_PRMTD_AMT,
SUM(ESTMTD_SLS_FULL_REV_CASE_QTY) AS ESTMTD_SLS_FULL_REV_CASE_QTY,
SUM(SLS_FULL_REV_EA_QTY) AS SLS_FULL_REV_EA_QTY,
SUM(SLS_FULL_REV_AMT) AS SLS_FULL_REV_AMT,
SUM(TOT_PRMTN_ALWNC_AMT) AS TOT_PRMTN_ALWNC_AMT,
SUM(CNTRCTL_DSCNT_AMT) AS CNTRCTL_DSCNT_AMT,
/*SUM(ESTMTD_TKT_SLS_CASE_QTY),
SUM(TKT_SLS_EA_QTY),
SUM(TKT_SLS_AMT),*/

SUM(CRSS_DK_TKT_SLS_AMT) AS CRSS_DK_TKT_SLS_AMT,
SUM(TKT_SLS_WT) AS TKT_SLS_WT,
ABS(SUM(TKT_SLS_RCLL_AMT)) AS TKT_SLS_RCLL_AMT,
ABS(SUM(TKT_SLS_RCLL_CASE_QTY)) AS TKT_SLS_RCLL_CASE_QTY,
ABS(SUM(TKT_SLS_RCLL_EA_QTY)) AS TKT_SLS_RCLL_EA_QTY,
ABS(SUM(TKT_SLS_RLLD_AMT)) AS TKT_SLS_RLLD_AMT,
ABS(SUM(TKT_SLS_RLLD_CASE_QTY)) AS TKT_SLS_RLLD_CASE_QTY,
ABS(SUM(TKT_SLS_RLLD_EA_QTY)) AS TKT_SLS_RLLD_EA_QTY,
SUM(CRSS_DK_TKT_SLS_CASE_QTY) AS CRSS_DK_TKT_SLS_CASE_QTY,
SUM(CRSS_DK_TKT_SLS_EA_QTY) AS CRSS_DK_TKT_SLS_EA_QTY,
SUM(CRSS_DK_TKT_SLS_WT) AS CRSS_DK_TKT_SLS_WT,
 COALESCE(  ACQ_PGT_SYS_ID,'GMP') AS ACQ_PGT_SYS_ID,
 COALESCE(  ACQ_MDM_SYS_ID,'627') AS ACQ_MDM_SYS_ID,
 COALESCE(  MANDT,'500'         ) AS MANDT,
 COALESCE(  ZSYSID,'A1P'        ) AS ZSYSID,
DW_BTCH_ID,
DW_STEP_ID,
MAX(DW_CRTD_DTM) AS DW_CRTD_DTM,
DW_UPDT_DTM,
IUD_FLAG,
GTMU_ID,
SUM(CRSS_DK_TOT_PRMTN_ALWNC_AMT) AS CRSS_DK_TOT_PRMTN_ALWNC_AMT
FROM(
SELECT
  AKEY.XREF_DW_CUST_ID AS DW_CUST_ID,
  AKEY.XREF_DW_MTRL_ID AS DW_MTRL_ID,
  AKEY.INVC_DT,
  AKEY.XREF_CUST_ID AS CUST_ID,
  AKEY.CUST_ID AS XREF_CUST_ID,
  AKEY.DW_CUST_ID AS XREF_DW_CUST_ID,
  AKEY.XREF_MTRL_ID AS MTRL_ID,
  AKEY.MTRL_ID AS XREF_MTRL_ID,
  AKEY.DW_MTRL_ID AS XREF_DW_MTRL_ID,
  AKEY.CRU_ID,
  AKEY.SYS_ID,
  AKEY.SOLD_TO_CTRY_ISO_CDV AS CTRY_ISO_CDV,
  'US29' AS CO_CDV,
  'US29' AS SLS_ORG_CDV,
  CASE WHEN AKEY.SRC_ID='702' AND CLNT_ID IS NOT NULL AND AKEY.DW_SLS_ACTVTY_CDV = 'SLS' THEN COALESCE(AKEY.CASE_EQVLNT_QTY,0)
  WHEN AKEY.DW_SLS_ACTVTY_CDV = 'SLS' THEN  COALESCE(AKEY.CASE_EQVLNT_QTY,0) ELSE 0 END AS ESTMTD_SLS_CASE_QTY, ---Changed as part of XDOCK-PGT
  CASE WHEN AKEY.SRC_ID='702' AND CLNT_ID IS NOT NULL AND AKEY.DW_SLS_ACTVTY_CDV = 'SLS'  THEN COALESCE(AKEY.EA_EQVLNT_QTY,0)
  WHEN  DW_SLS_ACTVTY_CDV = 'SLS' THEN COALESCE(SELL_QTY,0) ELSE 0 END AS SLS_EA_QTY, ---Changed as part of XDOCK-PGT
  CASE WHEN DW_SLS_ACTVTY_CDV = 'SLS' THEN COALESCE( WHLSL_AMT,0) ELSE 0 END AS SLS_AMT,
  CASE
WHEN DW_SLS_ACTVTY_CDV = 'RTRN' THEN  COALESCE(((MTRL_UOM.DENOM_BS_UOM_CNVRSN_VAL/MTRL_UOM.NUMRTR_BS_UOM_CNVRSN_VAL)*(COALESCE(AKEY.SELL_QTY,0))),0)
ELSE 0
END  AS ESTMTD_SLS_RTRN_CASE_QTY,
CASE
WHEN AKEY.DW_SLS_ACTVTY_CDV = 'RTRN'   THEN (COALESCE(SELL_QTY,0))
ELSE 0 END AS SLS_RTRN_EA_QTY
,
 CASE
WHEN AKEY.DW_SLS_ACTVTY_CDV = 'RTRN'   THEN (COALESCE(WHLSL_AMT,0))
ELSE 0 END
 SLS_RTRN_AMT,
  CASE
WHEN DW_SLS_ACTVTY_CDV = 'RTRN' AND  SRC_SLS_TYP_CDV = 'STL' THEN  COALESCE(((MTRL_UOM.DENOM_BS_UOM_CNVRSN_VAL/MTRL_UOM.NUMRTR_BS_UOM_CNVRSN_VAL)*(COALESCE(SELL_QTY,0))),0)
ELSE 0 END
AS ESTMTD_SLS_STL_CASE_QTY,
  CASE WHEN DW_SLS_ACTVTY_CDV = 'RTRN'  AND SRC_SLS_TYP_CDV = 'STL'
THEN (COALESCE(SELL_QTY,0))
ELSE 0
END AS SLS_STL_EA_QTY ,
  CASE
WHEN DW_SLS_ACTVTY_CDV = 'RTRN'  AND SRC_SLS_TYP_CDV = 'STL'   THEN (COALESCE(WHLSL_AMT,0))
ELSE 0
END
AS SLS_STL_AMT,
  CASE
WHEN DW_SLS_ACTVTY_CDV = 'RTRN' AND  SRC_SLS_TYP_CDV = 'DFECT' THEN  COALESCE(((MTRL_UOM.DENOM_BS_UOM_CNVRSN_VAL/MTRL_UOM.NUMRTR_BS_UOM_CNVRSN_VAL)*(COALESCE(SELL_QTY,0))),0)
ELSE 0 END
AS ESTMTD_SLS_DFECT_CASE_QTY,
  CASE WHEN DW_SLS_ACTVTY_CDV = 'RTRN'  AND SRC_SLS_TYP_CDV = 'DFECT'
THEN (COALESCE(SELL_QTY,0))
ELSE 0
END AS SLS_DFECT_EA_QTY ,
  CASE
WHEN DW_SLS_ACTVTY_CDV = 'RTRN'  AND SRC_SLS_TYP_CDV = 'DFECT'   THEN (COALESCE(WHLSL_AMT,0))
ELSE 0
END AS SLS_DFECT_AMT
,
/*  COALESCE(ESTMTD_SLS_CASE_QTY,0) - COALESCE(ESTMTD_SLS_RTRN_CASE_QTY,0) AS ESTMTD_SLS_NET_SHPMT_CASE_QTY,
  COALESCE(SLS_EA_QTY,0) - COALESCE(SLS_RTRN_EA_QTY,0) AS SLS_NET_SHPMT_EA_QTY,
  (COALESCE(SLS_AMT,0) - COALESCE(SLS_RTRN_AMT,0)-COALESCE(TOT_PRMTN_ALWNC_AMT,0)) AS SLS_NET_SHPMT_AMT,*/
  CASE WHEN AKEY.DW_SLS_ACTVTY_CDV = 'RTRN'
        THEN   COALESCE(AKEY.NET_DSCNT_AMT,0) ELSE COALESCE(AKEY.NET_DSCNT_AMT,0)
END AS  SLS_NDSCNT_AMT,
  CASE WHEN AKEY.SRC_ID='702' AND CLNT_ID IS NOT NULL AND AKEY.CRSS_DK_DLVRY_FLG = 'Y' AND TOT_PRMTN_ALWNC_AMT <> 0 THEN COALESCE(AKEY.CASE_EQVLNT_QTY,0) --Added as part PGT XDOCK FIX
WHEN AKEY.PRMTN_FULL_REV_CDV = 'P' AND AKEY.DW_SLS_ACTVTY_CDV='SLS'
THEN COALESCE(CASE_EQVLNT_QTY,0)
WHEN AKEY.PRMTN_FULL_REV_CDV = 'P' AND AKEY.DW_SLS_ACTVTY_CDV <> 'SLS'
THEN COALESCE(((MTRL_UOM.DENOM_BS_UOM_CNVRSN_VAL/MTRL_UOM.NUMRTR_BS_UOM_CNVRSN_VAL)*(COALESCE(AKEY.SELL_QTY,0))),0)
ELSE 0
END  AS ESTMTD_SLS_PRMTD_CASE_QTY
,
 CASE WHEN AKEY.SRC_ID='702' AND CLNT_ID IS NOT NULL AND AKEY.CRSS_DK_DLVRY_FLG = 'Y' AND TOT_PRMTN_ALWNC_AMT <> 0 THEN AKEY.EA_EQVLNT_QTY --Added as part PGT XDOCK FIX
WHEN AKEY.PRMTN_FULL_REV_CDV = 'P' AND AKEY.DW_SLS_ACTVTY_CDV='SLS'
THEN AKEY.SELL_QTY
WHEN AKEY.PRMTN_FULL_REV_CDV = 'P' AND AKEY.DW_SLS_ACTVTY_CDV <> 'SLS' AND CLNT_ID IS NOT NULL
THEN AKEY.SELL_QTY
WHEN AKEY.PRMTN_FULL_REV_CDV = 'P' AND AKEY.DW_SLS_ACTVTY_CDV <> 'SLS' AND CLNT_ID IS NULL
THEN (-1) * AKEY.SELL_QTY
ELSE 0
END  AS SLS_PRMTD_EA_QTY
,
/*
  CASE
WHEN AKEY.PRMTN_FULL_REV_CDV = 'P' AND AKEY.DW_SLS_ACTVTY_CDV='SLS'
THEN COALESCE(WHLSL_AMT,0)
WHEN AKEY.PRMTN_FULL_REV_CDV = 'P' AND AKEY.DW_SLS_ACTVTY_CDV<>'SLS'
THEN COALESCE(WHLSL_AMT,0)
ELSE 0
END  AS SLS_PRMTD_AMT
*/
  CASE WHEN AKEY.SRC_ID='702' AND CLNT_ID IS NOT NULL AND AKEY.CRSS_DK_DLVRY_FLG = 'Y' AND AKEY.TOT_PRMTN_ALWNC_AMT <>0 THEN  WHLSL_AMT --Added as part PGT XDOCK FIX
WHEN AKEY.PRMTN_FULL_REV_CDV = 'P' AND AKEY.DW_SLS_ACTVTY_CDV='SLS'
THEN COALESCE(WHLSL_AMT,0)
WHEN AKEY.PRMTN_FULL_REV_CDV = 'P' AND AKEY.DW_SLS_ACTVTY_CDV<>'SLS' AND CLNT_ID IS NOT NULL
THEN COALESCE(WHLSL_AMT,0)
WHEN AKEY.PRMTN_FULL_REV_CDV = 'P' AND AKEY.DW_SLS_ACTVTY_CDV<>'SLS' AND CLNT_ID IS NULL
THEN (-1) * COALESCE(WHLSL_AMT,0)
ELSE 0
END  AS SLS_PRMTD_AMT
,
  CASE WHEN AKEY.SRC_ID='702' AND CLNT_ID IS NOT NULL AND AKEY.CRSS_DK_DLVRY_FLG = 'Y' AND AKEY.TOT_PRMTN_ALWNC_AMT = 0 THEN COALESCE(AKEY.CASE_EQVLNT_QTY,0) --Added as part PGT XDOCK FIX
WHEN AKEY.PRMTN_FULL_REV_CDV = 'F' AND AKEY.DW_SLS_ACTVTY_CDV='SLS'
THEN COALESCE(CASE_EQVLNT_QTY,0)
WHEN AKEY.PRMTN_FULL_REV_CDV = 'F' AND AKEY.DW_SLS_ACTVTY_CDV <> 'SLS'
THEN COALESCE(((MTRL_UOM.DENOM_BS_UOM_CNVRSN_VAL/MTRL_UOM.NUMRTR_BS_UOM_CNVRSN_VAL)*(COALESCE(AKEY.SELL_QTY,0))),0)
ELSE 0
END  AS ESTMTD_SLS_FULL_REV_CASE_QTY
,
  CASE WHEN AKEY.SRC_ID='702' AND CLNT_ID IS NOT NULL AND AKEY.CRSS_DK_DLVRY_FLG = 'Y' AND AKEY.TOT_PRMTN_ALWNC_AMT = 0 THEN AKEY.EA_EQVLNT_QTY --Added as part PGT XDOCK FIX
WHEN AKEY.PRMTN_FULL_REV_CDV = 'F' AND AKEY.DW_SLS_ACTVTY_CDV='SLS'
THEN AKEY.SELL_QTY
WHEN AKEY.PRMTN_FULL_REV_CDV = 'F' AND AKEY.DW_SLS_ACTVTY_CDV <> 'SLS' AND CLNT_ID IS NOT NULL
THEN AKEY.SELL_QTY
WHEN AKEY.PRMTN_FULL_REV_CDV = 'F' AND AKEY.DW_SLS_ACTVTY_CDV <> 'SLS' AND CLNT_ID IS NULL
THEN (-1) * AKEY.SELL_QTY
ELSE 0
END AS SLS_FULL_REV_EA_QTY
,
/*
  CASE
WHEN AKEY.PRMTN_FULL_REV_CDV = 'F' AND AKEY.DW_SLS_ACTVTY_CDV='SLS'
THEN COALESCE(WHLSL_AMT,0)
WHEN AKEY.PRMTN_FULL_REV_CDV = 'F' AND AKEY.DW_SLS_ACTVTY_CDV<>'SLS'
THEN COALESCE(WHLSL_AMT,0)
ELSE 0
END  AS SLS_FULL_REV_AMT
,
*/
  CASE
WHEN AKEY.SRC_ID='702' AND CLNT_ID IS NOT NULL AND AKEY.CRSS_DK_DLVRY_FLG = 'Y' AND AKEY.TOT_PRMTN_ALWNC_AMT =0 THEN WHLSL_AMT --Added as part PGT XDOCK FIX
WHEN AKEY.PRMTN_FULL_REV_CDV = 'F' AND AKEY.DW_SLS_ACTVTY_CDV='SLS'
THEN COALESCE(WHLSL_AMT,0)
WHEN AKEY.PRMTN_FULL_REV_CDV = 'F' AND AKEY.DW_SLS_ACTVTY_CDV<>'SLS' AND CLNT_ID IS NOT NULL
THEN COALESCE(WHLSL_AMT,0)
WHEN AKEY.PRMTN_FULL_REV_CDV = 'F' AND AKEY.DW_SLS_ACTVTY_CDV<>'SLS' AND CLNT_ID IS NULL
THEN (-1) * COALESCE(WHLSL_AMT,0)
ELSE 0
END  AS SLS_FULL_REV_AMT
,
  CASE WHEN AKEY.DW_SLS_ACTVTY_CDV = 'RTRN' AND CLNT_ID IS NOT NULL
        THEN /*-1**/  COALESCE(AKEY.TOT_PRMTN_ALWNC_AMT,0)
       WHEN AKEY.DW_SLS_ACTVTY_CDV = 'RTRN' AND CLNT_ID IS NULL
        THEN -1*  COALESCE(AKEY.TOT_PRMTN_ALWNC_AMT,0) ELSE COALESCE(AKEY.TOT_PRMTN_ALWNC_AMT,0)
END  AS TOT_PRMTN_ALWNC_AMT, ---Changed as part of XDOCK-PGT

CASE WHEN AKEY.DW_SLS_ACTVTY_CDV = 'RTRN' AND CLNT_ID IS NOT NULL
        THEN/* -1* */ COALESCE(AKEY.TOT_DSCNT_AMT,0)
        WHEN AKEY.DW_SLS_ACTVTY_CDV = 'RTRN' AND CLNT_ID IS NULL
        THEN -1*  COALESCE(AKEY.TOT_DSCNT_AMT,0) ELSE COALESCE(AKEY.TOT_DSCNT_AMT,0)
END  AS CNTRCTL_DSCNT_AMT -- ---Changed as part of XDOCK-PGT

,
/*  (COALESCE(ESTMTD_SLS_CASE_QTY,0) - COALESCE(ESTMTD_SLS_RTRN_CASE_QTY,0)) AS  ESTMTD_TKT_SLS_CASE_QTY   ,
  (COALESCE(SLS_EA_QTY,0) - COALESCE(SLS_RTRN_EA_QTY,0)) AS  TKT_SLS_EA_QTY  ,
  (COALESCE(SLS_AMT,0) - COALESCE(SLS_RTRN_AMT,0)) AS TKT_SLS_AMT,*/
  CASE
WHEN AKEY.CRSS_DK_DLVRY_FLG = 'Y' AND AKEY.DW_SLS_ACTVTY_CDV='SLS'
THEN COALESCE(AKEY.WHLSL_AMT,0)
WHEN AKEY.CRSS_DK_DLVRY_FLG = 'Y' AND AKEY.DW_SLS_ACTVTY_CDV<>'SLS' AND CLNT_ID IS NOT NULL
THEN /*-1**/ COALESCE(AKEY.WHLSL_AMT,0)
WHEN AKEY.CRSS_DK_DLVRY_FLG = 'Y' AND AKEY.DW_SLS_ACTVTY_CDV<>'SLS' AND CLNT_ID IS NULL
THEN -1* COALESCE(AKEY.WHLSL_AMT,0)
ELSE 0
END  AS CRSS_DK_TKT_SLS_AMT ---Changed as part of XDOCK-PGT
,
  COALESCE(AKEY.LB_EQVLNT_QTY,0) AS TKT_SLS_WT,
  CASE
WHEN AKEY.SRC_SLS_TYP_CDV = 'RCLL'
THEN   (COALESCE(AKEY.SELL_QTY,0) * COALESCE(WHLSL_UNIT_PRC,0))
ELSE 0
END  AS TKT_SLS_RCLL_AMT
,

CASE
WHEN AKEY.SRC_SLS_TYP_CDV = 'RCLL' THEN  (MTRL_UOM.DENOM_BS_UOM_CNVRSN_VAL/MTRL_UOM.NUMRTR_BS_UOM_CNVRSN_VAL)*(COALESCE(AKEY.SELL_QTY,0))
ELSE 0
END  AS TKT_SLS_RCLL_CASE_QTY,
  CASE
WHEN AKEY.SRC_SLS_TYP_CDV = 'RCLL'
THEN   COALESCE(AKEY.SELL_QTY,0)
ELSE 0
END  AS TKT_SLS_RCLL_EA_QTY
,

CASE
WHEN AKEY.SRC_SLS_TYP_CDV = 'RLLD'
THEN   (COALESCE(AKEY.SELL_QTY,0) * COALESCE(AKEY.WHLSL_UNIT_PRC,0))
ELSE 0
END  AS TKT_SLS_RLLD_AMT
,

CASE
WHEN AKEY.SRC_SLS_TYP_CDV = 'RLLD' THEN  (MTRL_UOM.DENOM_BS_UOM_CNVRSN_VAL/MTRL_UOM.NUMRTR_BS_UOM_CNVRSN_VAL)*(COALESCE(AKEY.SELL_QTY,0))
ELSE 0
END  AS TKT_SLS_RLLD_CASE_QTY,
  CASE
WHEN AKEY.SRC_SLS_TYP_CDV = 'RLLD'
THEN   COALESCE(AKEY.SELL_QTY,0)
ELSE 0
END  AS TKT_SLS_RLLD_EA_QTY,
CASE WHEN AKEY.SRC_ID='702' AND CLNT_ID IS NOT NULL AND AKEY.CRSS_DK_DLVRY_FLG = 'Y' AND AKEY.DW_SLS_ACTVTY_CDV='SLS' THEN COALESCE(AKEY.CASE_EQVLNT_QTY,0) ---Changed as part of XDOCK-PGT
WHEN AKEY.CRSS_DK_DLVRY_FLG = 'Y' AND AKEY.DW_SLS_ACTVTY_CDV='SLS'
THEN COALESCE(ESTMTD_SLS_CASE_QTY,0) - COALESCE(ESTMTD_SLS_RTRN_CASE_QTY,0)
WHEN AKEY.CRSS_DK_DLVRY_FLG = 'Y' AND AKEY.DW_SLS_ACTVTY_CDV<>'SLS'
THEN (-1)*(COALESCE(ESTMTD_SLS_CASE_QTY,0) - COALESCE(ESTMTD_SLS_RTRN_CASE_QTY,0))
ELSE 0
END   AS CRSS_DK_TKT_SLS_CASE_QTY,
CASE WHEN AKEY.SRC_ID='702' AND CLNT_ID IS NOT NULL AND AKEY.CRSS_DK_DLVRY_FLG = 'Y' AND AKEY.DW_SLS_ACTVTY_CDV='SLS' THEN COALESCE(AKEY.EA_EQVLNT_QTY,0) ---Changed as part of XDOCK-PGT
WHEN AKEY.CRSS_DK_DLVRY_FLG = 'Y' AND AKEY.DW_SLS_ACTVTY_CDV='SLS'
THEN COALESCE(SLS_EA_QTY,0) - COALESCE(SLS_RTRN_EA_QTY,0)
WHEN AKEY.CRSS_DK_DLVRY_FLG = 'Y' AND AKEY.DW_SLS_ACTVTY_CDV<>'SLS'
THEN (-1) * (COALESCE(SLS_EA_QTY,0) - COALESCE(SLS_RTRN_EA_QTY,0))
ELSE 0
END AS CRSS_DK_TKT_SLS_EA_QTY,
CASE
WHEN AKEY.CRSS_DK_DLVRY_FLG = 'Y' AND AKEY.DW_SLS_ACTVTY_CDV='SLS'
THEN
COALESCE(AKEY.LB_EQVLNT_QTY,0)
WHEN AKEY.CRSS_DK_DLVRY_FLG = 'Y' AND AKEY.DW_SLS_ACTVTY_CDV<>'SLS'
THEN -1* (COALESCE(AKEY.LB_EQVLNT_QTY,0))
ELSE 0
END AS CRSS_DK_TKT_SLS_WT,
/*  AKEY.MDG_INSTNC_SYS_ID AS ACQ_PGT_SYS_ID,
  AKEY.MDM_SYS_ID AS ACQ_MDM_SYS_ID,
  AKEY.CLNT_ID AS MANDT,
  AKEY.HANA_INSTNC_SYS_ID AS ZSYSID,*/
 COALESCE(  AKEY.MDG_INSTNC_SYS_ID,'GMP') AS ACQ_PGT_SYS_ID,
 COALESCE(  AKEY.MDM_SYS_ID,'627') AS ACQ_MDM_SYS_ID,
 COALESCE(  AKEY.CLNT_ID,'500'         ) AS MANDT,
 COALESCE(  AKEY.HANA_INSTNC_SYS_ID,'A1P'        ) AS ZSYSID,
  MYBTCH_ID AS DW_BTCH_ID,
  MYSTEP_ID AS DW_STEP_ID,
  --CURRENT_TIMESTAMP(0) AS DW_CRTD_DTM,
  AKEY.DW_CRTD_DTM AS DW_CRTD_DTM,
  CURRENT_TIMESTAMP(0) AS DW_UPDT_DTM,
  NULL  IUD_FLAG,
  --'799' AS GTMU_ID,
  COALESCE(AKEY.GTMU_ID,'799') AS GTMU_ID,
CASE
WHEN AKEY.CRSS_DK_DLVRY_FLG = 'Y' and AKEY.DW_SLS_ACTVTY_CDV='SLS'
THEN COALESCE(AKEY.TOT_PRMTN_ALWNC_AMT,0)
WHEN AKEY.CRSS_DK_DLVRY_FLG = 'Y' and AKEY.DW_SLS_ACTVTY_CDV<>'SLS'
THEN  (-1)* COALESCE(AKEY.TOT_PRMTN_ALWNC_AMT,0)
ELSE 0
END AS CRSS_DK_TOT_PRMTN_ALWNC_AMT

FROM
DWL_P.DW_SLS AS akey
INNER JOIN (SEL DISTINCT * FROM VT_FLNA_SLS_RESTAT) FLNA_SLS
ON akey.XREF_DW_CUST_ID=FLNA_SLS.DW_CUST_ID
AND akey.XREF_DW_MTRL_ID=FLNA_SLS.DW_MTRL_ID
AND akey.INVC_DT=FLNA_SLS.INVC_DT
        LEFT OUTER JOIN
  (
    SELECT MAX(ACTVTY.CUR_BTCH_ID) AS MYBTCH_ID, MAX(STEP.STEP_ID) AS MYSTEP_ID
    FROM PEPCMN_P.STEP
    INNER JOIN PEPCMN_P.ACTVTY
    ON ACTVTY.ACTVTY_ID = STEP.ACTVTY_ID
    INNER JOIN PEPCMN_P.SYS
    ON SYS.SYS_NM = ACTVTY.SYS_NM
    WHERE
    SYS.SYS_NM ='DWL' AND
    ACTVTY_NM = 'LD_PGT_FLNA_SLS_CUST_MTRL_SUMMRY' AND
    STEP_NM = 'DW_PGT_FLNA_SLS_CUST_MTRL_SUMMRY_LOAD'
   ) THIS_STEP ON 1=1

  LEFT OUTER JOIN
  (
    SELECT DT_PRM2.CTL_STRT_DTM, CTL_END_DTM
    FROM PEPCMN_P.DT_PRM2
    WHERE STEP_ID IN
    (
     SELECT STEP_ID
     FROM PEPCMN_P.STEP
     JOIN PEPCMN_P.ACTVTY
     ON ACTVTY.ACTVTY_ID = STEP.ACTVTY_ID AND SYS_NM = 'DWL' AND ACTVTY_NM = 'LD_PGT_FLNA_SLS_CUST_MTRL_SUMMRY'
     WHERE
     STEP_NM = 'DW_PGT_FLNA_SLS_CUST_MTRL_SUMMRY_LOAD'
     )
     AND SYS_ID = 0
   ) THIS_STEP_DATES ON 1=1

/*
LEFT OUTER JOIN ACQ_P.GTMD_DDH_MTRL_UOM_CF AS MTRL_UOM
    --ON (AKEY.MTRL_ID=MTRL_UOM.MTRL_UOM_ID)
        ON (TRIM(AKEY.XREF_MTRL_ID)=TRIM(LEADING '0' FROM MTRL_UOM.MTRL_UOM_ID))
    AND (AKEY.CLNT_ID=MTRL_UOM.CLIENT_ID)
    --AND (AKEY.HANA_INSTNC_SYS_ID=MTRL_UOM.PGT_SYS_ID)
        AND (AKEY.MDG_INSTNC_SYS_ID=MTRL_UOM.PGT_SYS_ID)
    AND (MTRL_UOM.MTRL_UOM_CDV='CS') */

LEFT OUTER JOIN ACQ_P.GTMD_DDH_MTRL_UOM_CF AS MTRL_UOM
    --ON (AKEY.MTRL_ID=MTRL_UOM.MTRL_UOM_ID)
        ON (TRIM(AKEY.XREF_MTRL_ID)=TRIM(LEADING '0' FROM MTRL_UOM.MTRL_UOM_ID))
    --AND (AKEY.CLNT_ID=MTRL_UOM.CLIENT_ID)
        AND MTRL_UOM.CLIENT_ID = '500'
    --AND (AKEY.HANA_INSTNC_SYS_ID=MTRL_UOM.PGT_SYS_ID)
        -- AND (AKEY.MDG_INSTNC_SYS_ID=MTRL_UOM.PGT_SYS_ID)
                AND MTRL_UOM.PGT_SYS_ID = 'GMP'
    AND (MTRL_UOM.MTRL_UOM_CDV='CS')
WHERE
AKEY.CRU_ID=46
AND AKEY.SYS_ID=702) SLS
GROUP BY
DW_CUST_ID,
DW_MTRL_ID,
INVC_DT,
CUST_ID,
XREF_CUST_ID,
XREF_DW_CUST_ID,
MTRL_ID,
XREF_MTRL_ID,
XREF_DW_MTRL_ID,
CRU_ID,
SYS_ID,
CTRY_ISO_CDV,
CO_CDV,
SLS_ORG_CDV,
ACQ_PGT_SYS_ID,
ACQ_MDM_SYS_ID,
MANDT,
ZSYSID,
DW_BTCH_ID,
DW_STEP_ID,
--DW_CRTD_DTM,
DW_UPDT_DTM,
IUD_FLAG,
GTMU_ID
) A;

 *** Insert completed. 3445403 rows added. 
 *** Total elapsed time was 53 seconds.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

--AKEY.DW_LAST_UPDT_DTM >= COALESCE(CTL_STRT_DTM,CAST('1900-01-01 00:00:00' AS TIMESTAMP(0))) AND
--AKEY.DW_LAST_UPDT_DTM <= COALESCE(CTL_END_DTM,CAST('1900-01-01 00:00:00' AS TIMESTAMP(0)));


.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

INSERT INTO DWL_P_DRVD_WORK.PGT_FLNA_SLS_CUST_GTMU_MTRL_SUMMRY_STG
( DW_CUST_ID
,DW_MTRL_ID
,INVC_DT
,CRU_ID
,SYS_ID
,CTRY_ISO_CDV
,CO_CDV
,XREF_DW_CUST_ID
,XREF_DW_MTRL_ID
,XREF_CUST_ID
,XREF_MTRL_ID
,CUST_ID
,MTRL_ID
,SLS_ORG_CDV
,GTMU_ID
--,DSTRBTN_CHNL_CDV
,ESTMTD_SLS_CASE_QTY
,SLS_EA_QTY
,SLS_AMT
,ESTMTD_SLS_RTRN_CASE_QTY
,SLS_RTRN_EA_QTY
,SLS_RTRN_AMT
,ESTMTD_SLS_STL_CASE_QTY
,SLS_STL_EA_QTY
,SLS_STL_AMT
,ESTMTD_SLS_DFECT_CASE_QTY
,SLS_DFECT_EA_QTY
,SLS_DFECT_AMT
,ESTMTD_SLS_NET_SHPMT_CASE_QTY
,SLS_NET_SHPMT_EA_QTY
,SLS_NET_SHPMT_AMT
,SLS_NDSCNT_AMT
,ESTMTD_SLS_PRMTD_CASE_QTY
,SLS_PRMTD_EA_QTY
,SLS_PRMTD_AMT
,ESTMTD_SLS_FULL_REV_CASE_QTY
,SLS_FULL_REV_EA_QTY
,SLS_FULL_REV_AMT
,TOT_PRMTN_ALWNC_AMT
,CNTRCTL_DSCNT_AMT
,ESTMTD_TKT_SLS_CASE_QTY
,TKT_SLS_EA_QTY
,TKT_SLS_AMT
,CRSS_DK_TKT_SLS_AMT
,DW_BTCH_ID
,DW_STEP_ID
,DW_CRTD_DTM
,DW_UPDT_DTM
,IUD_FLAG
,TKT_SLS_WT
,TKT_SLS_RCLL_AMT
,TKT_SLS_RCLL_CASE_QTY
,TKT_SLS_RCLL_EA_QTY
,TKT_SLS_RLLD_AMT
,TKT_SLS_RLLD_CASE_QTY
,TKT_SLS_RLLD_EA_QTY
,CRSS_DK_TKT_SLS_CASE_QTY
,CRSS_DK_TKT_SLS_EA_QTY
,CRSS_DK_TKT_SLS_WT
,CRSS_DK_TOT_PRMTN_ALWNC_AMT
,ACQ_PGT_SYS_ID
,ACQ_MDM_SYS_ID
,MANDT
,ZSYSID
)
SELECT
SLS.DW_CUST_ID
,SLS.DW_MTRL_ID
,SLS.INVC_DT
,SLS.CRU_ID
,SLS.SYS_ID
,SLS.CTRY_ISO_CDV
,SLS.CO_CDV
,SLS.XREF_DW_CUST_ID
,SLS.XREF_DW_MTRL_ID
,SLS.XREF_CUST_ID
,SLS.XREF_MTRL_ID
,SLS.CUST_ID
,SLS.MTRL_ID
,SLS.SLS_ORG_CDV
,SLS.GTMU_ID
--,SLS.DSTRBTN_CHNL_CDV
,SUM(SLS.ESTMTD_SLS_CASE_QTY) AS ESTMTD_SLS_CASE_QTY
,SUM(SLS.SLS_EA_QTY)        AS SLS_EA_QTY
,SUM(SLS.SLS_AMT) AS SLS_AMT
,SUM(SLS.ESTMTD_SLS_RTRN_CASE_QTY) AS ESTMTD_SLS_RTRN_CASE_QTY
,SUM(SLS.SLS_RTRN_EA_QTY)         AS SLS_RTRN_EA_QTY
,SUM(SLS.SLS_RTRN_AMT)       AS SLS_RTRN_AMT
,SUM(SLS.ESTMTD_SLS_STL_CASE_QTY) AS ESTMTD_SLS_STL_CASE_QTY
,SUM(SLS.SLS_STL_EA_QTY)        AS SLS_STL_EA_QTY
,SUM(SLS.SLS_STL_AMT)      AS SLS_STL_AMT
,SUM(SLS.ESTMTD_SLS_DFECT_CASE_QTY) AS ESTMTD_SLS_DFECT_CASE_QTY
,SUM(SLS.SLS_DFECT_EA_QTY)      AS SLS_DFECT_EA_QTY
,SUM(SLS.SLS_DFECT_AMT)   AS SLS_DFECT_AMT
,SUM(SLS.ESTMTD_SLS_NET_SHPMT_CASE_QTY) AS ESTMTD_SLS_NET_SHPMT_CASE_QTY
,SUM(SLS.SLS_NET_SHPMT_EA_QTY) AS SLS_NET_SHPMT_EA_QTY
,SUM(COALESCE(SLS.SLS_AMT,0) - COALESCE(SLS.SLS_RTRN_AMT,0)-COALESCE(SLS.TOT_PRMTN_ALWNC_AMT,0)) AS SLS_NET_SHPMT_AMT
,SUM(SLS.SLS_NDSCNT_AMT) AS SLS_NDSCNT_AMT
,SUM(SLS.ESTMTD_SLS_PRMTD_CASE_QTY) AS ESTMTD_SLS_PRMTD_CASE_QTY
,SUM(SLS.SLS_PRMTD_EA_QTY) AS SLS_PRMTD_EA_QTY
,SUM(SLS.SLS_PRMTD_AMT) AS SLS_PRMTD_AMT
,SUM(SLS.ESTMTD_SLS_FULL_REV_CASE_QTY) AS ESTMTD_SLS_FULL_REV_CASE_QTY
,SUM(SLS.SLS_FULL_REV_EA_QTY) AS SLS_FULL_REV_EA_QTY
,SUM(SLS.SLS_FULL_REV_AMT) AS SLS_FULL_REV_AMT
,SUM(SLS.TOT_PRMTN_ALWNC_AMT) AS TOT_PRMTN_ALWNC_AMT
,SUM(SLS.CNTRCTL_DSCNT_AMT) AS CNTRCTL_DSCNT_AMT
,SUM(SLS.ESTMTD_TKT_SLS_CASE_QTY) AS ESTMTD_TKT_SLS_CASE_QTY
,SUM(SLS.TKT_SLS_EA_QTY) AS TKT_SLS_EA_QTY
,SUM(SLS.TKT_SLS_AMT) AS TKT_SLS_AMT
,SUM(SLS.CRSS_DK_TKT_SALE_AMT) AS CRSS_DK_TKT_SLS_AMT
,MYBTCH_ID AS DW_BTCH_ID
,MYSTEP_ID AS DW_STEP_ID
,CURRENT_TIMESTAMP(0) AS DW_CRTD_DTM
,CURRENT_TIMESTAMP(0) AS DW_UPDT_DTM
,NULL AS IUD_FLAG
,SUM(TKT_SLS_WT) AS TKT_SLS_WT
,SUM(TKT_SLS_RCL_AMT) AS TKT_SLS_RCLL_AMT
,SUM(TKT_SLS_RCL_CASE_QTY) AS TKT_SLS_RCLL_CASE_QTY
,SUM(TKT_SLS_RCL_EA_QTY) AS TKT_SLS_RCLL_EA_QTY
,SUM(TKT_SLS_ROLL_AMT) AS TKT_SLS_RLLD_AMT
,SUM(TKT_SLS_ROLL_CASE_QTY) AS TKT_SLS_RLLD_CASE_QTY
,SUM(TKT_SLS_ROLL_EA_QTY) AS TKT_SLS_RLLD_EA_QTY
,SUM(CRSS_DK_TKT_SLS_CASE_QTY) AS CRSS_DK_TKT_SLS_CASE_QTY
,SUM(CRSS_DK_TKT_SLS_EA_QTY) AS CRSS_DK_TKT_SLS_EA_QTY
,SUM(CRSS_DK_TKT_SLS_WT) AS CRSS_DK_TKT_SLS_WT
,SUM(CRSS_DK_TOT_PRMTN_ALWNC_AMT) AS CRSS_DK_TOT_PRMTN_ALWNC_AMT
,COALESCE(ACQ_PGT_SYS_ID,'GMP') AS ACQ_PGT_SYS_ID
,COALESCE(ACQ_MDM_SYS_ID,'627') AS ACQ_MDM_SYS_ID
,COALESCE(MANDT,'500') AS MANDT
,COALESCE(ZSYSID,'A1P') AS ZSYSID
FROM
(
SELECT
 --CUST_XREF.DW_CUST_XREF_ID AS DW_CUST_ID
--,MTRL_XREF.DW_MTRL_XREF_ID AS DW_MTRL_ID
SLS.XREF_DW_CUST_ID AS DW_CUST_ID
,SLS.XREF_DW_MTRL_ID AS DW_MTRL_ID
,SLS.INVC_DT AS INVC_DT
,SLS.CRU_ID AS CRU_ID
--,SLS.SYS_ID AS SYS_ID
,'702' AS SYS_ID
,SLS.SOLD_TO_CTRY_ISO_CDV AS CTRY_ISO_CDV
,'CA11' AS CO_CDV
--,SLS.DW_CUST_ID AS XREF_DW_CUST_ID
--,SLS.DW_MTRL_ID AS XREF_DW_MTRL_ID
,CASE WHEN SLS.SYS_ID='140' THEN CUST_XREF.DW_CUST_XREF_ID
     ELSE SLS.DW_CUST_ID END AS XREF_DW_CUST_ID
,CASE WHEN SLS.SYS_ID='140' THEN MTRL_XREF.DW_MTRL_XREF_ID
     ELSE SLS.DW_MTRL_ID END AS XREF_DW_MTRL_ID
,SLS.CUST_ID AS XREF_CUST_ID
,SLS.MTRL_ID AS XREF_MTRL_ID
,SLS.XREF_CUST_ID AS CUST_ID
,SLS.XREF_MTRL_ID AS MTRL_ID
,'CA11' AS SLS_ORG_CDV
--,'802' AS GTMU_ID
,SLS.GTMU_ID AS GTMU_ID
--,'NA' AS DSTRBTN_CHNL_CDV
/*,CASE
WHEN SLS.DW_SLS_ACTVTY_CDV = 'SLS'
THEN ((CASE WHEN SLS.SELL_QTY =0  THEN 1 ELSE COALESCE(SLS.SELL_QTY,0) END) / UOMCS.CNTNR_CMPNT_QTY)
ELSE 0
END AS ESTMTD_SLS_CASE_QTY*/
,CASE
WHEN SLS.DW_SLS_ACTVTY_CDV = 'SLS'
THEN ((COALESCE(SLS.SELL_QTY,0)) / CNTNR_CMPNT_QTY)
ELSE 0
END AS ESTMTD_SLS_CASE_QTY --Fix Decimal Issue by PFNA L3 Team -15 SEP 2023
,CASE
WHEN SLS.DW_SLS_ACTVTY_CDV = 'SLS'   THEN COALESCE(SLS.SELL_QTY,0)
ELSE 0
END AS SLS_EA_QTY
,CASE
WHEN SLS.DW_SLS_ACTVTY_CDV = 'SLS'   THEN COALESCE(WHLSL_AMT,0)
ELSE 0
END AS SLS_AMT

,CASE
WHEN SLS.DW_SLS_ACTVTY_CDV = 'RTRN'
THEN ABS((COALESCE(SLS.SELL_QTY,0)) / UOMCS.CNTNR_CMPNT_QTY)
ELSE 0
END AS ESTMTD_SLS_RTRN_CASE_QTY

,CASE
WHEN SLS.DW_SLS_ACTVTY_CDV = 'RTRN'   THEN ABS(COALESCE(SELL_QTY,0))
ELSE 0
END AS SLS_RTRN_EA_QTY
,CASE
WHEN SLS.DW_SLS_ACTVTY_CDV = 'RTRN'   THEN ABS(COALESCE(WHLSL_AMT,0))
ELSE 0
END AS SLS_RTRN_AMT
/* Change fro CA 2019/04/03
,CASE
WHEN SLS.DW_SLS_ACTVTY_CDV = 'RTRN' AND  SLS.SRC_SLS_TYP_CDV = 'STL'
THEN ((COALESCE(SLS.SELL_QTY,0)) / UOMCS.CNTNR_CMPNT_QTY)
ELSE 0
END AS ESTMTD_SLS_STL_CASE_QTY
*/
,NULL AS ESTMTD_SLS_STL_CASE_QTY
/* Change fro CA 2019/04/03
,CASE
WHEN SLS.DW_SLS_ACTVTY_CDV = 'RTRN'  AND SLS.SRC_SLS_TYP_CDV = 'STL'
THEN COALESCE(SELL_QTY,0)
ELSE 0
END AS SLS_STL_EA_QTY
*/
,NULL AS SLS_STL_EA_QTY
-- Fix for CA unsaleables 3/29/2019
/* Change fro CA 2019/04/03
,CASE
WHEN SLS.DW_SLS_ACTVTY_CDV = 'RTRN'  AND SLS.SRC_SLS_TYP_CDV = 'STL'   THEN COALESCE(WHLSL_AMT,0)
ELSE 0
END AS SLS_STL_AMT
*/
-- ,0 AS SLS_STL_AMT
, NULL AS SLS_STL_AMT

,CASE
WHEN SLS.DW_SLS_ACTVTY_CDV = 'RTRN' AND  SLS.SRC_SLS_TYP_CDV = '10'  --changed from SRC_SLS_TYP_CDV = 'DFECT'
THEN ABS((COALESCE(SLS.SELL_QTY,0)) / UOMCS.CNTNR_CMPNT_QTY)
ELSE 0
END AS ESTMTD_SLS_DFECT_CASE_QTY
,CASE
WHEN SLS.DW_SLS_ACTVTY_CDV = 'RTRN'  AND SLS.SRC_SLS_TYP_CDV = '10'  --changed from SRC_SLS_TYP_CDV = 'DFECT'
THEN ABS(COALESCE(SELL_QTY,0))
ELSE 0
END AS SLS_DFECT_EA_QTY
,CASE
WHEN SLS.DW_SLS_ACTVTY_CDV = 'RTRN'  AND SLS.SRC_SLS_TYP_CDV = '10'   THEN ABS(COALESCE(WHLSL_AMT,0))
ELSE 0
END AS SLS_DFECT_AMT
,(COALESCE(ESTMTD_SLS_CASE_QTY,0) - COALESCE(ESTMTD_SLS_RTRN_CASE_QTY,0)) AS ESTMTD_SLS_NET_SHPMT_CASE_QTY
,(COALESCE(SLS_EA_QTY,0) - COALESCE(SLS_RTRN_EA_QTY,0)) AS SLS_NET_SHPMT_EA_QTY
--,(COALESCE(SLS_AMT,0) - COALESCE(SLS_RTRN_AMT,0)-COALESCE(SLS.TOT_PRMTN_ALWNC_AMT,0)) AS SLS_NET_SHPMT_AMT
, COALESCE(SLS.NET_DSCNT_AMT,0)   SLS_NDSCNT_AMT
,CASE
WHEN SLS.PRMTN_FULL_REV_CDV = 'P' AND SLS.DW_SLS_ACTVTY_CDV='SLS'
THEN ((COALESCE(SLS.SELL_QTY,0)) / UOMCS.CNTNR_CMPNT_QTY)
WHEN SLS.PRMTN_FULL_REV_CDV = 'P' AND SLS.DW_SLS_ACTVTY_CDV <> 'SLS'
THEN (-1) * ((COALESCE(SLS.SELL_QTY,0)) /UOMCS.CNTNR_CMPNT_QTY)
ELSE 0
END AS ESTMTD_SLS_PRMTD_CASE_QTY
,CASE
WHEN SLS.PRMTN_FULL_REV_CDV = 'P' AND SLS.DW_SLS_ACTVTY_CDV='SLS'
THEN COALESCE(SELL_QTY,0)
WHEN SLS.PRMTN_FULL_REV_CDV = 'P' AND SLS.DW_SLS_ACTVTY_CDV<>'SLS'
THEN (-1)*(COALESCE(SELL_QTY,0))
ELSE 0
END AS SLS_PRMTD_EA_QTY
,CASE
WHEN SLS.PRMTN_FULL_REV_CDV = 'P' AND SLS.DW_SLS_ACTVTY_CDV='SLS'
THEN COALESCE(WHLSL_AMT,0)
WHEN SLS.PRMTN_FULL_REV_CDV = 'P' AND SLS.DW_SLS_ACTVTY_CDV<>'SLS'
THEN (-1)*(COALESCE(WHLSL_AMT,0))
ELSE 0
END AS SLS_PRMTD_AMT
,CASE
WHEN SLS.PRMTN_FULL_REV_CDV = 'F' AND SLS.DW_SLS_ACTVTY_CDV='SLS'
THEN ((COALESCE(SLS.SELL_QTY,0)) / UOMCS.CNTNR_CMPNT_QTY)
WHEN SLS.PRMTN_FULL_REV_CDV = 'F' AND SLS.DW_SLS_ACTVTY_CDV <> 'SLS'
THEN (-1) * ((COALESCE(SLS.SELL_QTY,0)) /UOMCS.CNTNR_CMPNT_QTY)
ELSE 0
END AS ESTMTD_SLS_FULL_REV_CASE_QTY
,CASE
WHEN SLS.PRMTN_FULL_REV_CDV = 'F' AND SLS.DW_SLS_ACTVTY_CDV='SLS'
THEN COALESCE(SELL_QTY,0)
WHEN SLS.PRMTN_FULL_REV_CDV = 'F' AND SLS.DW_SLS_ACTVTY_CDV<>'SLS'
THEN (-1)*(COALESCE(SELL_QTY,0))
ELSE 0
END AS SLS_FULL_REV_EA_QTY
,CASE
WHEN SLS.PRMTN_FULL_REV_CDV = 'F' AND SLS.DW_SLS_ACTVTY_CDV='SLS'
THEN COALESCE(WHLSL_AMT,0)
WHEN SLS.PRMTN_FULL_REV_CDV = 'F' AND SLS.DW_SLS_ACTVTY_CDV<>'SLS'
THEN (-1)*(COALESCE(WHLSL_AMT,0))
ELSE 0
END AS SLS_FULL_REV_AMT
,CASE WHEN SLS.DW_SLS_ACTVTY_CDV = 'RTRN'
        THEN  (-1)* COALESCE(SLS.TOT_PRMTN_ALWNC_AMT,0) ELSE COALESCE(SLS.TOT_PRMTN_ALWNC_AMT,0)
END AS TOT_PRMTN_ALWNC_AMT
,COALESCE(SLS.TOT_DSCNT_AMT,0) AS CNTRCTL_DSCNT_AMT
,(COALESCE(ESTMTD_SLS_CASE_QTY,0) - COALESCE(ESTMTD_SLS_RTRN_CASE_QTY,0)) AS  ESTMTD_TKT_SLS_CASE_QTY
,(COALESCE(SLS_EA_QTY,0) - COALESCE(SLS_RTRN_EA_QTY,0)) AS  TKT_SLS_EA_QTY
,(COALESCE(SLS_AMT,0) - COALESCE(SLS_RTRN_AMT,0)) AS TKT_SLS_AMT
,0 AS CRSS_DK_TKT_SALE_AMT
,MYBTCH_ID
,MYSTEP_ID
,COALESCE(SLS.LB_EQVLNT_QTY,0) AS TKT_SLS_WT
,CASE
WHEN SLS.SRC_SLS_TYP_CDV = 'RCLL'
THEN   (COALESCE(SLS.SELL_QTY,0) * COALESCE(WHLSL_UNIT_PRC,0))
ELSE 0
END AS TKT_SLS_RCL_AMT
,CASE
WHEN SLS.SRC_SLS_TYP_CDV = 'RCLL'
THEN ((COALESCE(SLS.SELL_QTY,0)) / UOMCS.CNTNR_CMPNT_QTY)
ELSE 0
END AS TKT_SLS_RCL_CASE_QTY
,CASE
WHEN SLS.SRC_SLS_TYP_CDV = 'RCLL'
THEN   COALESCE(SLS.SELL_QTY,0)
ELSE 0
END AS TKT_SLS_RCL_EA_QTY

,CASE
WHEN SLS.SRC_SLS_TYP_CDV = 'RLLD'
THEN   (COALESCE(SLS.SELL_QTY,0) * COALESCE(WHLSL_UNIT_PRC,0))
ELSE 0
END AS TKT_SLS_ROLL_AMT
,CASE
WHEN SLS.SRC_SLS_TYP_CDV = 'RLLD'
THEN ((COALESCE(SLS.SELL_QTY,0)) / UOMCS.CNTNR_CMPNT_QTY)
ELSE 0
END AS TKT_SLS_ROLL_CASE_QTY
,CASE
WHEN SLS.SRC_SLS_TYP_CDV = 'RLLD'
THEN   COALESCE(SLS.SELL_QTY,0)
ELSE 0
END AS TKT_SLS_ROLL_EA_QTY
,0 AS CRSS_DK_TKT_SLS_CASE_QTY
,0 AS CRSS_DK_TKT_SLS_EA_QTY
,0 AS CRSS_DK_TKT_SLS_WT
,0 AS CRSS_DK_TOT_PRMTN_ALWNC_AMT
,COALESCE(SLS.MDG_INSTNC_SYS_ID,'GMP') AS ACQ_PGT_SYS_ID
,COALESCE(SLS.MDM_SYS_ID,'627') AS ACQ_MDM_SYS_ID
,COALESCE(SLS.CLNT_ID,'500') AS MANDT
,COALESCE(SLS.HANA_INSTNC_SYS_ID,'A1P') AS ZSYSID
FROM DWL_P.DW_SLS SLS
INNER JOIN VT_FLNA_SLS_RESTAT_CA FLNA_SLS
ON SLS.XREF_DW_CUST_ID=FLNA_SLS.DW_CUST_ID
AND SLS.XREF_DW_MTRL_ID=FLNA_SLS.DW_MTRL_ID
AND SLS.INVC_DT=FLNA_SLS.INVC_DT
LEFT JOIN DWL_P.FLNA_ICF_FLML_CUST_XREF CUST_XREF
ON SLS.DW_CUST_ID=CUST_XREF.DW_CUST_ID
LEFT JOIN DWL_P.FLNA_ICF_FLML_MTRL_XREF MTRL_XREF
ON SLS.DW_MTRL_ID=MTRL_XREF.DW_MTRL_ID
LEFT OUTER JOIN
  (
    SELECT MAX(ACTVTY.CUR_BTCH_ID) AS MYBTCH_ID, MAX(STEP.STEP_ID) AS MYSTEP_ID
    FROM PEPCMN_P.STEP
    INNER JOIN PEPCMN_P.ACTVTY
    ON ACTVTY.ACTVTY_ID = STEP.ACTVTY_ID
    INNER JOIN PEPCMN_P.SYS
    ON SYS.SYS_NM = ACTVTY.SYS_NM
    WHERE
    SYS.SYS_NM ='DWL' AND
    ACTVTY_NM = 'LD_PGT_FLNA_SLS_CUST_MTRL_SUMMRY' AND
    STEP_NM = 'DW_PGT_FLNA_SLS_CUST_MTRL_SUMMRY_LOAD'
   ) THIS_STEP ON 1=1

/*LEFT OUTER JOIN MTRL_UOM_CASE_CA UOMCS
ON UOMCS.DW_MTRL_ID=MTRL_XREF.DW_MTRL_XREF_ID*/

LEFT OUTER JOIN ACQ_P.GTMD_DDH_MTRL_UOM_CF AS UOMCS
        ON (TRIM(SLS.XREF_MTRL_ID)=TRIM(LEADING '0' FROM UOMCS.MTRL_UOM_ID))
        AND UOMCS.CLIENT_ID = '500'
        AND UOMCS.PGT_SYS_ID = 'GMP'
        AND UOMCS.MTRL_UOM_CDV='CS'

WHERE SLS.CRU_ID=1
---AND SLS.SYS_ID=702

) SLS
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,44,45,46,47,48,60,61,62,63;

 *** Insert completed. No rows added. 
 *** Total elapsed time was 17 seconds.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-


 SELECT CURRENT_TIMESTAMP(0);

 *** Query completed. One row found. One column returned. 
 *** Total elapsed time was 1 second.

     Current TimeStamp(0)
-------------------------
2025-08-07 05:57:59-05:00

+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

UPDATE TGT FROM
DWL_P_DRVD_WORK.PGT_FLNA_SLS_CUST_GTMU_MTRL_SUMMRY_STG TGT,
XREF_CUST_VTBL XREF_CUST
SET --GTMU_ID = XREF_CUST.GTMU_ID,
SLS_ORG_CDV = CASE WHEN CTRY_ISO_CDV = 'US' THEN 'US29'
WHEN CTRY_ISO_CDV = 'CA' THEN 'CA11' END,
CO_CDV = CASE WHEN CTRY_ISO_CDV = 'US' THEN 'US29'
WHEN CTRY_ISO_CDV = 'CA' THEN 'CA11' END
WHERE TGT.CUST_ID = XREF_CUST.SCOLV1
AND CASE WHEN CTRY_ISO_CDV = 'US' THEN 'US29'
WHEN CTRY_ISO_CDV = 'CA' THEN 'CA11' END = XREF_CUST.SCOLV2
AND (TGT.SLS_ORG_CDV IS NULL OR TGT.CO_CDV IS NULL)
--AND ( TGT.GTMU_ID IS NULL OR TGT.GTMU_ID  = '-999')
;

 *** Update completed. No rows changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

UPDATE DWL_P_DRVD_WORK.PGT_FLNA_SLS_CUST_GTMU_MTRL_SUMMRY_STG  SET DW_ERR = 'Y'
WHERE  (  DW_CUST_ID, DW_MTRL_ID, INVC_DT/*,GTMU_ID*/ ) IN
(
SELECT  DW_CUST_ID, DW_MTRL_ID, INVC_DT/*,GTMU_ID*/
FROM DWL_P_DRVD_WORK.PGT_FLNA_SLS_CUST_GTMU_MTRL_SUMMRY_STG
GROUP BY  DW_CUST_ID, DW_MTRL_ID, INVC_DT/*,GTMU_ID*/ HAVING COUNT(*) > 1
);

 *** Update completed. 356 rows changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.IF ACTIVITYCOUNT = 0 THEN .GOTO skip_dup_pk_report;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

 SELECT CURRENT_TIMESTAMP(0);

 *** Query completed. One row found. One column returned. 
 *** Total elapsed time was 1 second.

     Current TimeStamp(0)
-------------------------
2025-08-07 05:58:00-05:00

+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

INSERT INTO DWL_P_INTL_JOB.RECORD_ERRORS(STEP_ID, BTCH_ID, ERR_CD, PRMY_SRC_TBL, TGT_TBL, STRT_EXTRCT, END_EXTRCT, ERR_DESC)
SELECT DISTINCT THIS_STEP.MYSTEP_ID,THIS_STEP.MYBTCH_ID,'Primary Key Check','DWL_P.DW_SLS','DWL_P_DRVD.PGT_FLNA_SLS_CUST_GTMU_MTRL_SUMMRY',THIS_STEP.STEP_STRT_DTM,CURRENT_TIMESTAMP(0),'One or more records had duplicate PK values for columns  DW_CUST_ID,
 DW_MTRL_ID, INVC_DT, GTMU_ID'
FROM
 (
    SELECT MAX(ACTVTY.CUR_BTCH_ID) AS MYBTCH_ID, MAX(STEP.STEP_ID) AS MYSTEP_ID,MAX(SE.STRT_DTM) AS STEP_STRT_DTM
    FROM PEPCMN_P.STEP
    INNER JOIN PEPCMN_P.ACTVTY
    ON ACTVTY.ACTVTY_ID = STEP.ACTVTY_ID
    INNER JOIN PEPCMN_P.SYS
    ON SYS.SYS_NM = ACTVTY.SYS_NM
        INNER JOIN
    PEPCMN_P.STEP_EVNT SE ON
    STEP.STEP_ID=SE.STEP_ID
    WHERE
    SYS.SYS_NM = 'DWL' AND
    ACTVTY_NM = 'LD_PGT_FLNA_SLS_CUST_MTRL_SUMMRY' AND
    STEP_NM = 'DW_PGT_FLNA_SLS_CUST_MTRL_SUMMRY_LOAD'
  ) THIS_STEP;

 *** Insert completed. One row added. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

 SELECT CURRENT_TIMESTAMP(0);

 *** Query completed. One row found. One column returned. 
 *** Total elapsed time was 1 second.

     Current TimeStamp(0)
-------------------------
2025-08-07 05:58:01-05:00

+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.OS echo -e  "Duplicates for primary key column(s) are found in DWL stage table for step DW_PGT_FLNA_SLS_CUST_MTRL_SUMMRY_LOAD of actvity LD_PGT_FLNA_SLS_CUST_MTRL_SUMMRY" | mailx  -s "PROD : Primary Key Check for step DW_PGT_FLNA_SLS_CUST_MTRL_SUMMRY_LO
AD of actvity LD_PGT_FLNA_SLS_CUST_MTRL_SUMMRY " -r Primary_Key_Duplicates_Check itedwsdwldelivery@pepsico.com;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

 SELECT CURRENT_TIMESTAMP(0);

 *** Query completed. One row found. One column returned. 
 *** Total elapsed time was 1 second.

     Current TimeStamp(0)
-------------------------
2025-08-07 05:58:01-05:00

+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.label skip_dup_pk_report;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

/******************CHECK FOR NULL ERRORS, FLAG, AND REPORT *****************/
UPDATE DWL_P_DRVD_WORK.PGT_FLNA_SLS_CUST_GTMU_MTRL_SUMMRY_STG SET DW_ERR = 'Y'
WHERE  DW_CUST_ID IS NULL OR  DW_MTRL_ID IS NULL OR  INVC_DT IS NULL;

 *** Update completed. No rows changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.IF ACTIVITYCOUNT = 0 THEN .GOTO skip_not_null_report;
.GOTO skip_not_null_report;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

 SELECT CURRENT_TIMESTAMP(0);
 *** Skipped.
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
 *** Skipped.
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

INSERT INTO DWL_P_INTL_JOB.RECORD_ERRORS(STEP_ID, BTCH_ID, ERR_CD, PRMY_SRC_TBL, TGT_TBL, STRT_EXTRCT, END_EXTRCT, ERR_DESC)
SELECT DISTINCT THIS_STEP.MYSTEP_ID,THIS_STEP.MYBTCH_ID,'Not Null Check','DWL_P.DW_SLS','DWL_P_DRVD.PGT_FLNA_SLS_CUST_GTMU_MTRL_SUMMRY',THIS_STEP.STEP_STRT_DTM,CURRENT_TIMESTAMP(0),'One or more records had null values where it should be not null for col
umns  DW_CUST_ID, DW_MTRL_ID, INVC_DT'
FROM
 (
    SELECT MAX(ACTVTY.CUR_BTCH_ID) AS MYBTCH_ID, MAX(STEP.STEP_ID) AS MYSTEP_ID,MAX(SE.STRT_DTM) AS STEP_STRT_DTM
    FROM PEPCMN_P.STEP
    INNER JOIN PEPCMN_P.ACTVTY
    ON ACTVTY.ACTVTY_ID = STEP.ACTVTY_ID
    INNER JOIN PEPCMN_P.SYS
    ON SYS.SYS_NM = ACTVTY.SYS_NM
        INNER JOIN
    PEPCMN_P.STEP_EVNT SE ON
    STEP.STEP_ID=SE.STEP_ID
    WHERE
    SYS.SYS_NM = 'DWL' AND
    ACTVTY_NM = 'LD_PGT_FLNA_SLS_CUST_MTRL_SUMMRY' AND
    STEP_NM = 'DW_PGT_FLNA_SLS_CUST_MTRL_SUMMRY_LOAD'
  ) THIS_STEP;
 *** Skipped.
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
 *** Skipped.
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

 SELECT CURRENT_TIMESTAMP(0);
 *** Skipped.
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
 *** Skipped.
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.OS echo -e  "Null values are found in DWL stage table for not null column(s) for step DW_PGT_FLNA_SLS_CUST_MTRL_SUMMRY_LOAD of actvity LD_PGT_FLNA_SLS_CUST_MTRL_SUMMRY" | mailx  -s "PROD : Not Null Check for step DW_PGT_FLNA_SLS_CUST_MTRL_SUMMRY_LOAD of
 actvity LD_PGT_FLNA_SLS_CUST_MTRL_SUMMRY " -r Not_Null_Check itedwsdwldelivery@pepsico.com;
 *** Skipped.
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

 SELECT CURRENT_TIMESTAMP(0);
 *** Skipped.
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
 *** Skipped.
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

--DEL DWL_P_DRVD.PGT_FLNA_SLS_CUST_GTMU_MTRL_SUMMRY where invc_dt between '2020/12/27' and '2023/12/08';

.label skip_not_null_report;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

/******************WE UPSERT THE STAGE TABLE INTO THE TARGET TABLE USING SURROGATE *****************/
UPDATE DWL_P_DRVD.PGT_FLNA_SLS_CUST_GTMU_MTRL_SUMMRY
FROM (SEL * FROM  DWL_P_DRVD_WORK.PGT_FLNA_SLS_CUST_GTMU_MTRL_SUMMRY_STG WHERE COALESCE(DW_ERR,'N')<>'Y') as STG
SET
    CUST_ID = STG.CUST_ID,
    XREF_CUST_ID = STG.XREF_CUST_ID,
    XREF_DW_CUST_ID = STG.XREF_DW_CUST_ID,
    MTRL_ID = STG.MTRL_ID,
    XREF_MTRL_ID = STG.XREF_MTRL_ID,
    XREF_DW_MTRL_ID = STG.XREF_DW_MTRL_ID,
    CRU_ID = STG.CRU_ID,
    SYS_ID = STG.SYS_ID,
    CTRY_ISO_CDV = STG.CTRY_ISO_CDV,
    CO_CDV = STG.CO_CDV,
    SLS_ORG_CDV = STG.SLS_ORG_CDV,
    ESTMTD_SLS_CASE_QTY = STG.ESTMTD_SLS_CASE_QTY,
    SLS_EA_QTY = STG.SLS_EA_QTY,
    SLS_AMT = STG.SLS_AMT,
    ESTMTD_SLS_RTRN_CASE_QTY = STG.ESTMTD_SLS_RTRN_CASE_QTY,
    SLS_RTRN_EA_QTY = STG.SLS_RTRN_EA_QTY,
    SLS_RTRN_AMT = STG.SLS_RTRN_AMT,
    ESTMTD_SLS_STL_CASE_QTY = STG.ESTMTD_SLS_STL_CASE_QTY,
    SLS_STL_EA_QTY = STG.SLS_STL_EA_QTY,
    SLS_STL_AMT = STG.SLS_STL_AMT,
    ESTMTD_SLS_DFECT_CASE_QTY = STG.ESTMTD_SLS_DFECT_CASE_QTY,
    SLS_DFECT_EA_QTY = STG.SLS_DFECT_EA_QTY,
    SLS_DFECT_AMT = STG.SLS_DFECT_AMT,
    ESTMTD_SLS_NET_SHPMT_CASE_QTY = STG.ESTMTD_SLS_NET_SHPMT_CASE_QTY,
    SLS_NET_SHPMT_EA_QTY = STG.SLS_NET_SHPMT_EA_QTY,
    SLS_NET_SHPMT_AMT = STG.SLS_NET_SHPMT_AMT,
    SLS_NDSCNT_AMT = STG.SLS_NDSCNT_AMT,
    ESTMTD_SLS_PRMTD_CASE_QTY = STG.ESTMTD_SLS_PRMTD_CASE_QTY,
    SLS_PRMTD_EA_QTY = STG.SLS_PRMTD_EA_QTY,
    SLS_PRMTD_AMT = STG.SLS_PRMTD_AMT,
    ESTMTD_SLS_FULL_REV_CASE_QTY = STG.ESTMTD_SLS_FULL_REV_CASE_QTY,
    SLS_FULL_REV_EA_QTY = STG.SLS_FULL_REV_EA_QTY,
    SLS_FULL_REV_AMT = STG.SLS_FULL_REV_AMT,
    TOT_PRMTN_ALWNC_AMT = STG.TOT_PRMTN_ALWNC_AMT,
    CNTRCTL_DSCNT_AMT = STG.CNTRCTL_DSCNT_AMT,
    ESTMTD_TKT_SLS_CASE_QTY = STG.ESTMTD_TKT_SLS_CASE_QTY,
    TKT_SLS_EA_QTY = STG.TKT_SLS_EA_QTY,
    TKT_SLS_AMT = STG.TKT_SLS_AMT,
    CRSS_DK_TKT_SLS_AMT = STG.CRSS_DK_TKT_SLS_AMT,
    TKT_SLS_WT = STG.TKT_SLS_WT,
    TKT_SLS_RCLL_AMT = STG.TKT_SLS_RCLL_AMT,
    TKT_SLS_RCLL_CASE_QTY = STG.TKT_SLS_RCLL_CASE_QTY,
    TKT_SLS_RCLL_EA_QTY = STG.TKT_SLS_RCLL_EA_QTY,
    TKT_SLS_RLLD_AMT = STG.TKT_SLS_RLLD_AMT,
    TKT_SLS_RLLD_CASE_QTY = STG.TKT_SLS_RLLD_CASE_QTY,
    TKT_SLS_RLLD_EA_QTY = STG.TKT_SLS_RLLD_EA_QTY,
    CRSS_DK_TKT_SLS_CASE_QTY = STG.CRSS_DK_TKT_SLS_CASE_QTY,
    CRSS_DK_TKT_SLS_EA_QTY=STG.CRSS_DK_TKT_SLS_EA_QTY,
    CRSS_DK_TKT_SLS_WT=STG.CRSS_DK_TKT_SLS_WT,
    ACQ_PGT_SYS_ID = STG.ACQ_PGT_SYS_ID,
    ACQ_MDM_SYS_ID = STG.ACQ_MDM_SYS_ID,
    MANDT = STG.MANDT,
    ZSYSID = STG.ZSYSID,
    DW_UPDT_DTM=STG.DW_UPDT_DTM,
    DW_BTCH_ID = STG.DW_BTCH_ID,
    DW_STEP_ID = STG.DW_STEP_ID,
    CRSS_DK_TOT_PRMTN_ALWNC_AMT = STG.CRSS_DK_TOT_PRMTN_ALWNC_AMT,
    GTMU_ID = STG.GTMU_ID
WHERE
    DWL_P_DRVD.PGT_FLNA_SLS_CUST_GTMU_MTRL_SUMMRY.DW_CUST_ID = STG.DW_CUST_ID
AND DWL_P_DRVD.PGT_FLNA_SLS_CUST_GTMU_MTRL_SUMMRY.DW_MTRL_ID = STG.DW_MTRL_ID
AND DWL_P_DRVD.PGT_FLNA_SLS_CUST_GTMU_MTRL_SUMMRY.INVC_DT = STG.INVC_DT
--AND COALESCE(DWL_P_DRVD.PGT_FLNA_SLS_CUST_GTMU_MTRL_SUMMRY.GTMU_ID,-999) = COALESCE(STG.GTMU_ID,-999)
;

 *** Update completed. 2874305 rows changed. 
 *** Total elapsed time was 11 seconds.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

 SELECT CURRENT_TIMESTAMP(0);

 *** Query completed. One row found. One column returned. 
 *** Total elapsed time was 1 second.

     Current TimeStamp(0)
-------------------------
2025-08-07 05:58:12-05:00

+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

INSERT INTO DWL_P_DRVD.PGT_FLNA_SLS_CUST_GTMU_MTRL_SUMMRY
(
  DW_CUST_ID,
  DW_MTRL_ID,
  INVC_DT,
  CUST_ID,
  XREF_CUST_ID,
  XREF_DW_CUST_ID,
  MTRL_ID,
  XREF_MTRL_ID,
  XREF_DW_MTRL_ID,
  CRU_ID,
  SYS_ID,
  CTRY_ISO_CDV,
  CO_CDV,
  SLS_ORG_CDV,
  ESTMTD_SLS_CASE_QTY,
  SLS_EA_QTY,
  SLS_AMT,
  ESTMTD_SLS_RTRN_CASE_QTY,
  SLS_RTRN_EA_QTY,
  SLS_RTRN_AMT,
  ESTMTD_SLS_STL_CASE_QTY,
  SLS_STL_EA_QTY,
  SLS_STL_AMT,
  ESTMTD_SLS_DFECT_CASE_QTY,
  SLS_DFECT_EA_QTY,
  SLS_DFECT_AMT,
  ESTMTD_SLS_NET_SHPMT_CASE_QTY,
  SLS_NET_SHPMT_EA_QTY,
  SLS_NET_SHPMT_AMT,
  SLS_NDSCNT_AMT,
  ESTMTD_SLS_PRMTD_CASE_QTY,
  SLS_PRMTD_EA_QTY,
  SLS_PRMTD_AMT,
  ESTMTD_SLS_FULL_REV_CASE_QTY,
  SLS_FULL_REV_EA_QTY,
  SLS_FULL_REV_AMT,
  TOT_PRMTN_ALWNC_AMT,
  CNTRCTL_DSCNT_AMT,
  ESTMTD_TKT_SLS_CASE_QTY,
  TKT_SLS_EA_QTY,
  TKT_SLS_AMT,
  CRSS_DK_TKT_SLS_AMT,
  TKT_SLS_WT,
  TKT_SLS_RCLL_AMT,
  TKT_SLS_RCLL_CASE_QTY,
  TKT_SLS_RCLL_EA_QTY,
  TKT_SLS_RLLD_AMT,
  TKT_SLS_RLLD_CASE_QTY,
  TKT_SLS_RLLD_EA_QTY,
  CRSS_DK_TKT_SLS_CASE_QTY,
  CRSS_DK_TKT_SLS_EA_QTY,
  CRSS_DK_TKT_SLS_WT,
  ACQ_PGT_SYS_ID,
  ACQ_MDM_SYS_ID,
  MANDT,
  ZSYSID,
  DW_BTCH_ID,
  DW_STEP_ID,
  DW_CRTD_DTM,
  DW_UPDT_DTM,
  GTMU_ID,
  CRSS_DK_TOT_PRMTN_ALWNC_AMT
)
SELECT
  STG.DW_CUST_ID,
  STG.DW_MTRL_ID,
  STG.INVC_DT,
  STG.CUST_ID,
  STG.XREF_CUST_ID,
  STG.XREF_DW_CUST_ID,
  STG.MTRL_ID,
  STG.XREF_MTRL_ID,
  STG.XREF_DW_MTRL_ID,
  STG.CRU_ID,
  STG.SYS_ID,
  STG.CTRY_ISO_CDV,
  STG.CO_CDV,
  STG.SLS_ORG_CDV,
  STG.ESTMTD_SLS_CASE_QTY,
  STG.SLS_EA_QTY,
  STG.SLS_AMT,
  STG.ESTMTD_SLS_RTRN_CASE_QTY,
  STG.SLS_RTRN_EA_QTY,
  STG.SLS_RTRN_AMT,
  STG.ESTMTD_SLS_STL_CASE_QTY,
  STG.SLS_STL_EA_QTY,
  STG.SLS_STL_AMT,
  STG.ESTMTD_SLS_DFECT_CASE_QTY,
  STG.SLS_DFECT_EA_QTY,
  STG.SLS_DFECT_AMT,
  STG.ESTMTD_SLS_NET_SHPMT_CASE_QTY,
  STG.SLS_NET_SHPMT_EA_QTY,
  STG.SLS_NET_SHPMT_AMT,
  STG.SLS_NDSCNT_AMT,
  STG.ESTMTD_SLS_PRMTD_CASE_QTY,
  STG.SLS_PRMTD_EA_QTY,
  STG.SLS_PRMTD_AMT,
  STG.ESTMTD_SLS_FULL_REV_CASE_QTY,
  STG.SLS_FULL_REV_EA_QTY,
  STG.SLS_FULL_REV_AMT,
  STG.TOT_PRMTN_ALWNC_AMT,
  STG.CNTRCTL_DSCNT_AMT,
  STG.ESTMTD_TKT_SLS_CASE_QTY,
  STG.TKT_SLS_EA_QTY,
  STG.TKT_SLS_AMT,
  STG.CRSS_DK_TKT_SLS_AMT,
  STG.TKT_SLS_WT,
  STG.TKT_SLS_RCLL_AMT,
  STG.TKT_SLS_RCLL_CASE_QTY,
  STG.TKT_SLS_RCLL_EA_QTY,
  STG.TKT_SLS_RLLD_AMT,
  STG.TKT_SLS_RLLD_CASE_QTY,
  STG.TKT_SLS_RLLD_EA_QTY,
  STG.CRSS_DK_TKT_SLS_CASE_QTY,
  STG.CRSS_DK_TKT_SLS_EA_QTY,
  STG.CRSS_DK_TKT_SLS_WT,
  STG.ACQ_PGT_SYS_ID,
  STG.ACQ_MDM_SYS_ID,
  STG.MANDT,
  STG.ZSYSID,
  STG.DW_BTCH_ID,
  STG.DW_STEP_ID,
  STG.DW_CRTD_DTM,
  STG.DW_UPDT_DTM,
  COALESCE(STG.GTMU_ID,-999),
  STG.CRSS_DK_TOT_PRMTN_ALWNC_AMT
FROM (SEL * FROM  DWL_P_DRVD_WORK.PGT_FLNA_SLS_CUST_GTMU_MTRL_SUMMRY_STG
WHERE COALESCE(DW_ERR,'N')<>'Y'
) STG
LEFT OUTER JOIN
DWL_P_DRVD.PGT_FLNA_SLS_CUST_GTMU_MTRL_SUMMRY TGT
ON
    TGT.DW_CUST_ID = STG.DW_CUST_ID
AND TGT.DW_MTRL_ID = STG.DW_MTRL_ID
AND TGT.INVC_DT = STG.INVC_DT
--AND COALESCE(TGT.GTMU_ID,-999) = COALESCE(STG.GTMU_ID,-999)

WHERE
TGT.DW_CUST_ID IS NULL;

 *** Insert completed. 570742 rows added. 
 *** Total elapsed time was 4 seconds.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

INSERT INTO VT_DW_FLNA_SLS_CUST_STG
SEL DISTINCT DW_CUST_ID, INVC_DT FROM DWL_P_DRVD.PGT_FLNA_SLS_CUST_GTMU_MTRL_SUMMRY SUMMRY
WHERE SYS_ID = '702' AND CRU_ID ='46'
AND NOT EXISTS  (
SELECT DISTINCT XREF_DW_CUST_ID, XREF_DW_MTRL_ID,INVC_DT FROM DWL_P.DW_SLS SLS
WHERE SYS_ID = '702' AND CRU_ID ='46'
AND SLS.XREF_DW_CUST_ID = SUMMRY.DW_CUST_ID
AND SLS.XREF_DW_MTRL_ID = SUMMRY.DW_MTRL_ID
AND SLS.INVC_DT    = SUMMRY.INVC_DT
)
;

 *** Insert completed. No rows added. 
 *** Total elapsed time was 25 seconds.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

INSERT INTO DWL_P_DRVD.PGT_FLNA_SLS_CUST_GTMU_MTRL_SUMMRY_ARCV
(
DW_CUST_ID
,GTMU_ID
,DW_MTRL_ID
,INVC_DT
,CUST_ID
,XREF_CUST_ID
,XREF_DW_CUST_ID
,MTRL_ID
,XREF_MTRL_ID
,XREF_DW_MTRL_ID
,CRU_ID
,SYS_ID
,CTRY_ISO_CDV
,CO_CDV
,SLS_ORG_CDV
,ESTMTD_SLS_CASE_QTY
,SLS_EA_QTY
,SLS_AMT
,ESTMTD_SLS_RTRN_CASE_QTY
,SLS_RTRN_EA_QTY
,SLS_RTRN_AMT
,ESTMTD_SLS_STL_CASE_QTY
,SLS_STL_EA_QTY
,SLS_STL_AMT
,ESTMTD_SLS_DFECT_CASE_QTY
,SLS_DFECT_EA_QTY
,SLS_DFECT_AMT
,ESTMTD_SLS_NET_SHPMT_CASE_QTY
,SLS_NET_SHPMT_EA_QTY
,SLS_NET_SHPMT_AMT
,SLS_NDSCNT_AMT
,ESTMTD_SLS_PRMTD_CASE_QTY
,SLS_PRMTD_EA_QTY
,SLS_PRMTD_AMT
,ESTMTD_SLS_FULL_REV_CASE_QTY
,SLS_FULL_REV_EA_QTY
,SLS_FULL_REV_AMT
,TOT_PRMTN_ALWNC_AMT
,CNTRCTL_DSCNT_AMT
,ESTMTD_TKT_SLS_CASE_QTY
,TKT_SLS_EA_QTY
,TKT_SLS_AMT
,CRSS_DK_TKT_SLS_AMT
,TKT_SLS_WT
,TKT_SLS_RCLL_AMT
,TKT_SLS_RCLL_CASE_QTY
,TKT_SLS_RCLL_EA_QTY
,TKT_SLS_RLLD_AMT
,TKT_SLS_RLLD_CASE_QTY
,TKT_SLS_RLLD_EA_QTY
,ACQ_PGT_SYS_ID
,ACQ_MDM_SYS_ID
,MANDT
,ZSYSID
,DW_BTCH_ID
,DW_STEP_ID
,DW_CRTD_DTM
,DW_UPDT_DTM
,CRSS_DK_TKT_SLS_CASE_QTY
,CRSS_DK_TKT_SLS_EA_QTY
,CRSS_DK_TKT_SLS_WT
,CRSS_DK_TOT_PRMTN_ALWNC_AMT
)
SELECT
DW_CUST_ID
,GTMU_ID
,DW_MTRL_ID
,INVC_DT
,CUST_ID
,XREF_CUST_ID
,XREF_DW_CUST_ID
,MTRL_ID
,XREF_MTRL_ID
,XREF_DW_MTRL_ID
,CRU_ID
,SYS_ID
,CTRY_ISO_CDV
,CO_CDV
,SLS_ORG_CDV
,ESTMTD_SLS_CASE_QTY
,SLS_EA_QTY
,SLS_AMT
,ESTMTD_SLS_RTRN_CASE_QTY
,SLS_RTRN_EA_QTY
,SLS_RTRN_AMT
,ESTMTD_SLS_STL_CASE_QTY
,SLS_STL_EA_QTY
,SLS_STL_AMT
,ESTMTD_SLS_DFECT_CASE_QTY
,SLS_DFECT_EA_QTY
,SLS_DFECT_AMT
,ESTMTD_SLS_NET_SHPMT_CASE_QTY
,SLS_NET_SHPMT_EA_QTY
,SLS_NET_SHPMT_AMT
,SLS_NDSCNT_AMT
,ESTMTD_SLS_PRMTD_CASE_QTY
,SLS_PRMTD_EA_QTY
,SLS_PRMTD_AMT
,ESTMTD_SLS_FULL_REV_CASE_QTY
,SLS_FULL_REV_EA_QTY
,SLS_FULL_REV_AMT
,TOT_PRMTN_ALWNC_AMT
,CNTRCTL_DSCNT_AMT
,ESTMTD_TKT_SLS_CASE_QTY
,TKT_SLS_EA_QTY
,TKT_SLS_AMT
,CRSS_DK_TKT_SLS_AMT
,TKT_SLS_WT
,TKT_SLS_RCLL_AMT
,TKT_SLS_RCLL_CASE_QTY
,TKT_SLS_RCLL_EA_QTY
,TKT_SLS_RLLD_AMT
,TKT_SLS_RLLD_CASE_QTY
,TKT_SLS_RLLD_EA_QTY
,ACQ_PGT_SYS_ID
,ACQ_MDM_SYS_ID
,MANDT
,ZSYSID
,DW_BTCH_ID
,DW_STEP_ID
,DW_CRTD_DTM
,CURRENT_TIMESTAMP(0) AS DW_UPDT_DTM
,CRSS_DK_TKT_SLS_CASE_QTY
,CRSS_DK_TKT_SLS_EA_QTY
,CRSS_DK_TKT_SLS_WT
,CRSS_DK_TOT_PRMTN_ALWNC_AMT
FROM DWL_P_DRVD.PGT_FLNA_SLS_CUST_GTMU_MTRL_SUMMRY SUMMRY
WHERE SYS_ID = '702' AND CRU_ID ='46'
AND NOT EXISTS  (
SELECT DISTINCT XREF_DW_CUST_ID, XREF_DW_MTRL_ID,INVC_DT FROM DWL_P.DW_SLS SLS
WHERE SYS_ID = '702' AND CRU_ID ='46'
AND SLS.XREF_DW_CUST_ID = SUMMRY.DW_CUST_ID
AND SLS.XREF_DW_MTRL_ID = SUMMRY.DW_MTRL_ID
AND SLS.INVC_DT    = SUMMRY.INVC_DT
)
;

 *** Insert completed. No rows added. 
 *** Total elapsed time was 30 seconds.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

--Version 8
--start

INSERT INTO DWL_P_DRVD.PGT_FLNA_SLS_CUST_GTMU_MTRL_SUMMRY_ARCV
(
DW_CUST_ID
,GTMU_ID
,DW_MTRL_ID
,INVC_DT
,CUST_ID
,XREF_CUST_ID
,XREF_DW_CUST_ID
,MTRL_ID
,XREF_MTRL_ID
,XREF_DW_MTRL_ID
,CRU_ID
,SYS_ID
,CTRY_ISO_CDV
,CO_CDV
,SLS_ORG_CDV
,ESTMTD_SLS_CASE_QTY
,SLS_EA_QTY
,SLS_AMT
,ESTMTD_SLS_RTRN_CASE_QTY
,SLS_RTRN_EA_QTY
,SLS_RTRN_AMT
,ESTMTD_SLS_STL_CASE_QTY
,SLS_STL_EA_QTY
,SLS_STL_AMT
,ESTMTD_SLS_DFECT_CASE_QTY
,SLS_DFECT_EA_QTY
,SLS_DFECT_AMT
,ESTMTD_SLS_NET_SHPMT_CASE_QTY
,SLS_NET_SHPMT_EA_QTY
,SLS_NET_SHPMT_AMT
,SLS_NDSCNT_AMT
,ESTMTD_SLS_PRMTD_CASE_QTY
,SLS_PRMTD_EA_QTY
,SLS_PRMTD_AMT
,ESTMTD_SLS_FULL_REV_CASE_QTY
,SLS_FULL_REV_EA_QTY
,SLS_FULL_REV_AMT
,TOT_PRMTN_ALWNC_AMT
,CNTRCTL_DSCNT_AMT
,ESTMTD_TKT_SLS_CASE_QTY
,TKT_SLS_EA_QTY
,TKT_SLS_AMT
,CRSS_DK_TKT_SLS_AMT
,TKT_SLS_WT
,TKT_SLS_RCLL_AMT
,TKT_SLS_RCLL_CASE_QTY
,TKT_SLS_RCLL_EA_QTY
,TKT_SLS_RLLD_AMT
,TKT_SLS_RLLD_CASE_QTY
,TKT_SLS_RLLD_EA_QTY
,ACQ_PGT_SYS_ID
,ACQ_MDM_SYS_ID
,MANDT
,ZSYSID
,DW_BTCH_ID
,DW_STEP_ID
,DW_CRTD_DTM
,DW_UPDT_DTM
,CRSS_DK_TKT_SLS_CASE_QTY
,CRSS_DK_TKT_SLS_EA_QTY
,CRSS_DK_TKT_SLS_WT
,CRSS_DK_TOT_PRMTN_ALWNC_AMT
)
  SELECT
COALESCE(SUMMRY.XREF_DW_CUST_ID, SUMMRY.DW_CUST_ID)
,'-1' AS GTMU_ID -- V9
,COALESCE(SUMMRY.XREF_DW_MTRL_ID,SUMMRY.DW_MTRL_ID)
,SUMMRY.INVC_DT
,SUMMRY.XREF_CUST_ID
,SUMMRY.CUST_ID
,SUMMRY.DW_CUST_ID
,SUMMRY.XREF_MTRL_ID
,SUMMRY.MTRL_ID
,SUMMRY.DW_MTRL_ID
,'-1' AS CRU_ID --V9
,SUMMRY.SYS_ID
,SUMMRY.CTRY_ISO_CDV
,'US29' AS CO_CDV
,SUMMRY.SLS_ORG_CDV
,SUMMRY.ESTMTD_SLS_CASE_QTY
,SUMMRY.SLS_EA_QTY
,SUMMRY.SLS_AMT
,SUMMRY.ESTMTD_SLS_RTRN_CASE_QTY
,SUMMRY.SLS_RTRN_EA_QTY
,SUMMRY.SLS_RTRN_AMT
,SUMMRY.ESTMTD_SLS_STL_CASE_QTY
,SUMMRY.SLS_STL_EA_QTY
,SUMMRY.SLS_STL_AMT
,SUMMRY.ESTMTD_SLS_DFECT_CASE_QTY
,SUMMRY.SLS_DFECT_EA_QTY
,SUMMRY.SLS_DFECT_AMT
,SUMMRY.ESTMTD_SLS_NET_SHPMT_CASE_QTY
,SUMMRY.SLS_NET_SHPMT_EA_QTY
,SUMMRY.SLS_NET_SHPMT_AMT
,SUMMRY.SLS_NDSCNT_AMT
,SUMMRY.ESTMTD_SLS_PRMTD_CASE_QTY
,SUMMRY.SLS_PRMTD_EA_QTY
,SUMMRY.SLS_PRMTD_AMT
,SUMMRY.ESTMTD_SLS_FULL_REV_CASE_QTY
,SUMMRY.SLS_FULL_REV_EA_QTY
,SUMMRY.SLS_FULL_REV_AMT
,SUMMRY.TOT_PRMTN_ALWNC_AMT
,SUMMRY.CNTRCTL_DSCNT_AMT
,SUMMRY.ESTMTD_TKT_SLS_CASE_QTY
,SUMMRY.TKT_SLS_EA_QTY
,SUMMRY.TKT_SLS_AMT
,SUMMRY.CRSS_DK_TKT_SLS_AMT
,SUMMRY.TKT_SLS_WT
,SUMMRY.TKT_SLS_RCL_AMT
,SUMMRY.TKT_SLS_RCL_CASE_QTY
,SUMMRY.TKT_SLS_RCL_EA_QTY
,SUMMRY.TKT_SLS_ROLL_AMT
,SUMMRY.TKT_SLS_ROLL_CASE_QTY
,SUMMRY.TKT_SLS_ROLL_EA_QTY
,'GMP' AS ACQ_PGT_SYS_ID
,'627' AS ACQ_MDM_SYS_ID
,'500' AS MANDT
,'A1P' AS ZSYSID
,SUMMRY.DW_BTCH_ID
,SUMMRY.DW_STEP_ID
,SUMMRY.DW_CRTD_DTM
,CURRENT_TIMESTAMP(0) AS DW_UPDT_DTM
,SUMMRY.CRSS_DK_TKT_SLS_CASE_QTY
,SUMMRY.CRSS_DK_TKT_SLS_EA_QTY
,SUMMRY.CRSS_DK_TKT_SLS_WT
,SUMMRY.CRSS_DK_TOT_PRMTN_ALWNC_AMT
FROM DWL_P_DRVD.FLNA_SLS_CUST_MTRL_SUMMRY SUMMRY
LEFT JOIN DWL_P_DRVD.PGT_FLNA_SLS_CUST_GTMU_MTRL_SUMMRY_ARCV ARCV
ON SUMMRY.DW_CUST_ID = ARCV.XREF_DW_CUST_ID
AND SUMMRY.DW_MTRL_ID = ARCV.XREF_DW_MTRL_ID
AND SUMMRY.INVC_DT = ARCV.INVC_DT
WHERE SUMMRY.XREF_CUST_ID IN
(
SEL  DISTINCT PARM_ATRBT1_VAL FROM DWL_P_INTL.DW_DATA_PARM_ATRBT_VAL
WHERE PARM_ATRBT3_VAL ='NEW S4 CUSTOMER'
AND DW_UPDT_DTM >= (CURRENT_DATE - 7 )
)
AND ARCV.XREF_DW_CUST_ID IS NULL
AND SUMMRY.INVC_DT>='2021-10-31'
--AND SUMMRY.GTMU_ID = '-1'
;

 *** Insert completed. 40 rows added. 
 *** Total elapsed time was 7 seconds.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

--end

DELETE FROM DWL_P_DRVD.PGT_FLNA_SLS_CUST_GTMU_MTRL_SUMMRY SUMMRY
WHERE SYS_ID = '702' AND CRU_ID ='46'
AND NOT EXISTS  (
SELECT DISTINCT XREF_DW_CUST_ID, XREF_DW_MTRL_ID,INVC_DT FROM DWL_P.DW_SLS SLS
WHERE SYS_ID = '702' AND CRU_ID ='46'
AND SLS.XREF_DW_CUST_ID = SUMMRY.DW_CUST_ID
AND SLS.XREF_DW_MTRL_ID = SUMMRY.DW_MTRL_ID
AND SLS.INVC_DT    = SUMMRY.INVC_DT
)
;

 *** Delete completed. No rows removed. 
 *** Total elapsed time was 28 seconds.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-



DELETE FROM DWL_P_DRVD.PGT_FLNA_SLS_CUST_GTMU_MTRL_SUMMRY SUMMRY
WHERE CRU_ID ='1'
AND NOT EXISTS  (
SELECT DISTINCT XREF_DW_CUST_ID, XREF_DW_MTRL_ID,INVC_DT FROM DWL_P.DW_SLS SLS
WHERE CRU_ID ='1'
AND SLS.XREF_DW_CUST_ID = SUMMRY.DW_CUST_ID
AND SLS.XREF_DW_MTRL_ID = SUMMRY.DW_MTRL_ID
AND SLS.INVC_DT    = SUMMRY.INVC_DT
)
;

 *** Delete completed. No rows removed. 
 *** Total elapsed time was 12 seconds.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-


.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-



/*PGT_FLNA_SLS_CUST_DLY_SUMMRY Data load*/

INSERT INTO VT_DW_FLNA_SLS_CUST_STG
SELECT DW_CUST_ID
, INVC_DT
FROM DWL_P_DRVD_WORK.PGT_FLNA_SLS_CUST_GTMU_MTRL_SUMMRY_STG
WHERE COALESCE(DW_ERR,'N')<>'Y'
GROUP BY 1, 2;

 *** Insert completed. 127447 rows added. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

DELETE FROM DWL_P_BASE.PGT_FLNA_SLS_CUST_DLY_SUMMRY
WHERE (DW_CUST_ID, INVC_DT) IN (
SELECT DW_CUST_ID
, INVC_DT
FROM VT_DW_FLNA_SLS_CUST_STG
);

 *** Delete completed. 106658 rows removed. 
 *** Total elapsed time was 4 seconds.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

COLLECT STATISTICS
                   -- default SYSTEM SAMPLE PERCENT
                   -- default SYSTEM THRESHOLD PERCENT
            COLUMN ( DW_CUST_ID,CRU_ID,SYS_ID ) ,
            COLUMN ( DW_CUST_ID,INVC_DT ) ,
            COLUMN ( DW_CUST_ID ) ,
            COLUMN ( INVC_DT ) ,
            COLUMN ( SYS_ID ) ,
            COLUMN ( CRU_ID ) ,
            COLUMN ( DW_UPDT_DTM )
                ON DWL_P_BASE.PGT_FLNA_SLS_CUST_DLY_SUMMRY ;

 *** Update completed. 8 rows changed. 
 *** Total elapsed time was 2 seconds.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

COLLECT STATISTICS
             USING NO THRESHOLD DAYS
                   AND NO THRESHOLD PERCENT
                   -- default SYSTEM SAMPLE PERCENT
            COLUMN ( PARTITION,INVC_DT ) ,
            COLUMN ( PARTITION,CRU_ID )
                ON DWL_P_BASE.PGT_FLNA_SLS_CUST_DLY_SUMMRY ;

 *** Update completed. 3 rows changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

COLLECT STATISTICS
             USING MAXVALUELENGTH 200
                   -- default SYSTEM SAMPLE PERCENT
                   -- default SYSTEM THRESHOLD PERCENT
            COLUMN ( CO_CDV )
                ON DWL_P_BASE.PGT_FLNA_SLS_CUST_DLY_SUMMRY ;

 *** Update completed. 2 rows changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-



.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

INSERT INTO DWL_P_BASE.PGT_FLNA_SLS_CUST_DLY_SUMMRY
(
 DW_CUST_ID
,CUST_ID
,XREF_CUST_ID
,XREF_DW_CUST_ID
,GTMU_ID
,CO_CDV
,SLS_ORG_CDV
,MANDT
,ZSYSID
,ACQ_PGT_SYS_ID
,ACQ_MDM_SYS_ID
,INVC_DT
,CRU_ID
,SYS_ID
,CTRY_ISO_CDV
,ESTMTD_SLS_CASE_QTY
,SLS_EA_QTY
,SLS_AMT
,ESTMTD_SLS_RTRN_CASE_QTY
,SLS_RTRN_EA_QTY
,SLS_RTRN_AMT
,ESTMTD_SLS_STL_CASE_QTY
,SLS_STL_EA_QTY
,SLS_STL_AMT
,ESTMTD_SLS_DFECT_CASE_QTY
,SLS_DFECT_EA_QTY
,SLS_DFECT_AMT
,ESTMTD_SLS_NET_SHPMT_CASE_QTY
,SLS_NET_SHPMT_EA_QTY
,SLS_NET_SHPMT_AMT
,SLS_NDSCNT_AMT
,ESTMTD_SLS_PRMTD_CASE_QTY
,SLS_PRMTD_EA_QTY
,SLS_PRMTD_AMT
,ESTMTD_SLS_FULL_REV_CASE_QTY
,SLS_FULL_REV_EA_QTY
,SLS_FULL_REV_AMT
,TOT_PRMTN_ALWNC_AMT
,CNTRCTL_DSCNT_AMT
,ESTMTD_TKT_SLS_CASE_QTY
,TKT_SLS_EA_QTY
,TKT_SLS_AMT
,CRSS_DK_TKT_SLS_AMT
,DW_BTCH_ID
,DW_STEP_ID
,DW_CRTD_DTM
,DW_UPDT_DTM
,TKT_SLS_WT
,TKT_SLS_RCLL_AMT
,TKT_SLS_RCLL_CASE_QTY
,TKT_SLS_RCLL_EA_QTY
,TKT_SLS_RLLD_AMT
,TKT_SLS_RLLD_CASE_QTY
,TKT_SLS_RLLD_EA_QTY
,CRSS_DK_TOT_PRMTN_ALWNC_AMT
)
SELECT
 DW_CUST_ID
,CUST_ID
,XREF_CUST_ID
,XREF_DW_CUST_ID
,GTMU_ID
,CO_CDV
,SLS_ORG_CDV
,MANDT
,ZSYSID
,ACQ_PGT_SYS_ID
,ACQ_MDM_SYS_ID
,INVC_DT
,CRU_ID
,SYS_ID
,CTRY_ISO_CDV
,ESTMTD_SLS_CASE_QTY
,SLS_EA_QTY
,SLS_AMT
,ESTMTD_SLS_RTRN_CASE_QTY
,SLS_RTRN_EA_QTY
,SLS_RTRN_AMT
,ESTMTD_SLS_STL_CASE_QTY
,SLS_STL_EA_QTY
,SLS_STL_AMT
,ESTMTD_SLS_DFECT_CASE_QTY
,SLS_DFECT_EA_QTY
,SLS_DFECT_AMT
,ESTMTD_SLS_NET_SHPMT_CASE_QTY
,SLS_NET_SHPMT_EA_QTY
,SLS_NET_SHPMT_AMT
,SLS_NDSCNT_AMT
,ESTMTD_SLS_PRMTD_CASE_QTY
,SLS_PRMTD_EA_QTY
,SLS_PRMTD_AMT
,ESTMTD_SLS_FULL_REV_CASE_QTY
,SLS_FULL_REV_EA_QTY
,SLS_FULL_REV_AMT
,TOT_PRMTN_ALWNC_AMT
,CNTRCTL_DSCNT_AMT
,ESTMTD_TKT_SLS_CASE_QTY
,TKT_SLS_EA_QTY
,TKT_SLS_AMT
,CRSS_DK_TKT_SLS_AMT
,DW_BTCH_ID
,DW_STEP_ID
,DW_CRTD_DTM
,DW_UPDT_DTM
,TKT_SLS_WT
,TKT_SLS_RCLL_AMT
,TKT_SLS_RCLL_CASE_QTY
,TKT_SLS_RCLL_EA_QTY
,TKT_SLS_RLLD_AMT
,TKT_SLS_RLLD_CASE_QTY
,TKT_SLS_RLLD_EA_QTY
,CRSS_DK_TOT_PRMTN_ALWNC_AMT
FROM (
SELECT
 STG.DW_CUST_ID
,STG.CUST_ID
,STG.XREF_CUST_ID
,STG.XREF_DW_CUST_ID
,STG.GTMU_ID
,STG.CO_CDV
,STG.SLS_ORG_CDV
,STG.MANDT
,STG.ZSYSID
,STG.ACQ_PGT_SYS_ID
,STG.ACQ_MDM_SYS_ID
,STG.INVC_DT
,STG.CRU_ID
,STG.SYS_ID
,STG.CTRY_ISO_CDV
,Max(STG.DW_STEP_ID) AS DW_STEP_ID
,Max(STG.DW_BTCH_ID) AS DW_BTCH_ID
,Max(STG.DW_CRTD_DTM) AS DW_CRTD_DTM
,Max(STG.DW_UPDT_DTM) AS DW_UPDT_DTM
,Sum(STG.ESTMTD_SLS_CASE_QTY) AS ESTMTD_SLS_CASE_QTY
,Sum(STG.SLS_EA_QTY) AS SLS_EA_QTY
,Sum(STG.SLS_AMT) AS SLS_AMT
,Sum(STG.ESTMTD_SLS_RTRN_CASE_QTY) AS ESTMTD_SLS_RTRN_CASE_QTY
,Sum(STG.SLS_RTRN_EA_QTY) AS SLS_RTRN_EA_QTY
,Sum(STG.SLS_RTRN_AMT) AS SLS_RTRN_AMT
,Sum(STG.ESTMTD_SLS_STL_CASE_QTY) AS ESTMTD_SLS_STL_CASE_QTY
,Sum(STG.SLS_STL_EA_QTY) AS SLS_STL_EA_QTY
,Sum(STG.SLS_STL_AMT) AS SLS_STL_AMT
,Sum(STG.ESTMTD_SLS_DFECT_CASE_QTY) AS ESTMTD_SLS_DFECT_CASE_QTY
,Sum(STG.SLS_DFECT_EA_QTY) AS SLS_DFECT_EA_QTY
,Sum(STG.SLS_DFECT_AMT) AS SLS_DFECT_AMT
,Sum(STG.ESTMTD_SLS_NET_SHPMT_CASE_QTY) AS ESTMTD_SLS_NET_SHPMT_CASE_QTY
,Sum(STG.SLS_NET_SHPMT_EA_QTY) AS SLS_NET_SHPMT_EA_QTY
,Sum(STG.SLS_NET_SHPMT_AMT) AS SLS_NET_SHPMT_AMT
,Sum(STG.SLS_NDSCNT_AMT) AS SLS_NDSCNT_AMT
,Sum(STG.ESTMTD_SLS_PRMTD_CASE_QTY) AS ESTMTD_SLS_PRMTD_CASE_QTY
,Sum(STG.SLS_PRMTD_EA_QTY) AS SLS_PRMTD_EA_QTY
,Sum(STG.SLS_PRMTD_AMT) AS SLS_PRMTD_AMT
,Sum(STG.ESTMTD_SLS_FULL_REV_CASE_QTY) AS ESTMTD_SLS_FULL_REV_CASE_QTY
,Sum(STG.SLS_FULL_REV_EA_QTY) AS SLS_FULL_REV_EA_QTY
,Sum(STG.SLS_FULL_REV_AMT) AS SLS_FULL_REV_AMT
,Sum(STG.TOT_PRMTN_ALWNC_AMT) AS TOT_PRMTN_ALWNC_AMT
,Sum(STG.CNTRCTL_DSCNT_AMT) AS CNTRCTL_DSCNT_AMT
,Sum(STG.ESTMTD_TKT_SLS_CASE_QTY) AS ESTMTD_TKT_SLS_CASE_QTY
,Sum(STG.TKT_SLS_EA_QTY) AS TKT_SLS_EA_QTY
,Sum(STG.TKT_SLS_AMT) AS TKT_SLS_AMT
,Sum(STG.CRSS_DK_TKT_SLS_AMT) AS CRSS_DK_TKT_SLS_AMT
,Sum(STG.TKT_SLS_WT) AS TKT_SLS_WT
,Sum(STG.TKT_SLS_RCLL_AMT) AS TKT_SLS_RCLL_AMT
,Sum(STG.TKT_SLS_RCLL_CASE_QTY) AS TKT_SLS_RCLL_CASE_QTY
,Sum(STG.TKT_SLS_RCLL_EA_QTY) AS TKT_SLS_RCLL_EA_QTY
,Sum(STG.TKT_SLS_RLLD_AMT) AS TKT_SLS_RLLD_AMT
,Sum(STG.TKT_SLS_RLLD_CASE_QTY) AS TKT_SLS_RLLD_CASE_QTY
,Sum(STG.TKT_SLS_RLLD_EA_QTY  ) AS TKT_SLS_RLLD_EA_QTY
,SUM(CRSS_DK_TOT_PRMTN_ALWNC_AMT) AS CRSS_DK_TOT_PRMTN_ALWNC_AMT
FROM DWL_P_DRVD.PGT_FLNA_SLS_CUST_GTMU_MTRL_SUMMRY AS STG
WHERE (DW_CUST_ID, INVC_DT) IN (
SELECT DISTINCT DW_CUST_ID
, INVC_DT
FROM VT_DW_FLNA_SLS_CUST_STG
)
GROUP BY  STG.DW_CUST_ID
,STG.CUST_ID
,STG.XREF_CUST_ID
,STG.XREF_DW_CUST_ID
,STG.GTMU_ID
,STG.CO_CDV
,STG.SLS_ORG_CDV
,STG.MANDT
,STG.ZSYSID
,STG.ACQ_PGT_SYS_ID
,STG.ACQ_MDM_SYS_ID
,STG.INVC_DT
,STG.CRU_ID
,STG.SYS_ID
,STG.CTRY_ISO_CDV
--,STG.DW_STEP_ID
) A
;

 *** Insert completed. 127447 rows added. 
 *** Total elapsed time was 6 seconds.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

DELETE FROM DWL_P_BASE.PGT_FLNA_SLS_CUST_DLY_SUMMRY
WHERE (DW_CUST_ID, INVC_DT) NOT IN (
SELECT DISTINCT DW_CUST_ID , INVC_DT
FROM DWL_P_DRVD.PGT_FLNA_SLS_CUST_GTMU_MTRL_SUMMRY
);

 *** Delete completed. No rows removed. 
 *** Total elapsed time was 4 seconds.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

COLLECT STATS COLUMN(PARM_ATRBT1_VAL) ON DWL_P_INTL.DW_DATA_PARM_ATRBT_VAL;

 *** Update completed. 2 rows changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

 .IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

UPDATE TGT FROM
DWL_P_DRVD.FLNA_SLS_CUST_MTRL_SUMMRY TGT,
(sel DISTINCT PARM_ATRBT1_VAL from DWL_P_INTL.DW_DATA_PARM_ATRBT_VAL WHERE  PARM_ID = 34 ) PARM
SET GTMU_ID = '-1' , CRU_ID = '-1'
WHERE TGT.XREF_CUST_ID = PARM.PARM_ATRBT1_VAL
AND (TGT.GTMU_ID <> '-1'  OR TGT.GTMU_ID is null) and TGT.CRU_ID <> '-1'
AND TGT.CRU_ID='46'
;

 *** Update completed. 40 rows changed. 
 *** Total elapsed time was 3 seconds.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

UPDATE TGT FROM
DWL_P_DRVD.FLNA_SLS_CUST_DLY_SUMMRY TGT,
(sel DISTINCT PARM_ATRBT1_VAL from DWL_P_INTL.DW_DATA_PARM_ATRBT_VAL WHERE  PARM_ID = 34 ) PARM
SET GTMU_ID = '-1' , CRU_ID = '-1'
WHERE TGT.XREF_CUST_ID = PARM.PARM_ATRBT1_VAL
AND (TGT.GTMU_ID <> '-1'  OR TGT.GTMU_ID is null) and TGT.CRU_ID <> '-1'
AND TGT.CRU_ID='46'
;

 *** Update completed. One row changed. 
 *** Total elapsed time was 2 seconds.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-


 SELECT CURRENT_TIMESTAMP(0);

 *** Query completed. One row found. One column returned. 
 *** Total elapsed time was 1 second.

     Current TimeStamp(0)
-------------------------
2025-08-07 06:00:23-05:00

+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

 .IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

 EXEC PEPCMN_P.DT_PRM_RESET2 ('DWL', 'LD_PGT_FLNA_SLS_CUST_MTRL_SUMMRY', 'DW_PGT_FLNA_SLS_CUST_MTRL_SUMMRY_LOAD', 0);

 *** Update completed. One row changed. 
 *** Total elapsed time was 1 second.


 *** Query completed. One row found. 5 columns returned. 
             STEP_ID       SYS_ID         CTL_STRT_DTM          CTL_END_DTM               BTCH_ID
--------------------  -----------  -------------------  -------------------  --------------------
              59918.            0  2025-08-06 23:59:04  2025-08-07 06:00:23                  835.

+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

 SELECT CURRENT_TIMESTAMP(0);

 *** Query completed. One row found. One column returned. 
 *** Total elapsed time was 1 second.

     Current TimeStamp(0)
-------------------------
2025-08-07 06:00:23-05:00

+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

  .LOGOFF;
 *** You are now logged off from the DBC.
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
  .QUIT;
 *** Exiting BTEQ...
 *** RC (return code) = 0 
Return Code 0
Executing loadstats task
BTEQ 16.20.00.10 (64-bit) Thu Aug  7 06:00:23 2025 PID: 30831
 
+---------+---------+---------+---------+---------+---------+---------+----

 .run file /etlapps/prds2/dwl/intl/bin/dwl_intl_tdlogon.btq
+---------+---------+---------+---------+---------+---------+---------+----
.logon tdprod/DWL_BATCH_INTL_P,

 *** Logon successfully completed.
 *** Teradata Database Release is 17.20.03.16a                  
 *** Teradata Database Version is 17.20.03.16                     
 *** Transaction Semantics are BTET.
 *** Session Character Set Name is 'ASCII'.
 
 *** Total elapsed time was 16 seconds.
 
+---------+---------+---------+---------+---------+---------+---------+----

 *** Encountered EOF on RUN file. Returning to stdin.
+---------+---------+---------+---------+---------+---------+---------+----
 .IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+----

  .set width 254
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
  .set maxerror 4
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

  SELECT CURRENT_TIMESTAMP(0);

 *** Query completed. One row found. One column returned. 
 *** Total elapsed time was 1 second.

     Current TimeStamp(0)
-------------------------
2025-08-07 06:00:39-05:00

+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

  .IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

  -- insert the load statistics that are meant to occur (actually occurs before the load)
  
CREATE MULTISET VOLATILE TABLE VOL_LD_STATCS 
AS 
(
  SELECT
    THIS_STEP.STEP_ID ,
    THIS_STEP.CUR_BTCH_ID,
    DATABASENAME,
    TABLENAME,
    TBL1.*,
    TBL2.*,
    TBL3.*

  FROM DBC.TABLESV
  CROSS JOIN
  (
    SELECT MAX(ACTVTY.CUR_BTCH_ID) AS CUR_BTCH_ID, MAX(STEP.STEP_ID) AS STEP_ID
    FROM PEPCMN_P.STEP
    INNER JOIN PEPCMN_P.ACTVTY
      ON ACTVTY.ACTVTY_ID = STEP.ACTVTY_ID
    INNER JOIN PEPCMN_P.SYS
      ON SYS.SYS_NM = ACTVTY.SYS_NM
    WHERE
      SYS.SYS_NM = 'DWL' AND
      ACTVTY_NM = 'LD_PGT_FLNA_SLS_CUST_MTRL_SUMMRY' AND
      STEP_NM = 'DW_PGT_FLNA_SLS_CUST_MTRL_SUMMRY_LOAD'
  ) THIS_STEP
 CROSS JOIN
  -- CORE EXTRACT TEMP TABLE TOTAL
  (SELECT CAST(COUNT(*) AS DECIMAL(18,0)) AS CORE_TOTAL FROM DWL_P_BASE_WORK.PGT_FLNA_SLS_CUST_MTRL_SUMMRY_STG) TBL1

  CROSS JOIN
  -- DERIVED TABLE TOTAL
  (SELECT CAST(COUNT(*) AS DECIMAL(18,0)) AS DERIVED_TOTAL
   FROM
          DWL_P_BASE_WORK.PGT_FLNA_SLS_CUST_MTRL_SUMMRY_STG CORE
                  ) TBL2

  CROSS JOIN

( SELECT
--SUM(CASE WHEN A.IUD_FLAG='I' THEN  1 ELSE 0 END)  AS INSERT_TOTAL,
SUM(CAST((CASE WHEN A.IUD_FLAG='I' THEN  1 ELSE 0 END) AS DECIMAL(18,0))) AS INSERT_TOTAL,
SUM(CASE WHEN A.IUD_FLAG='U' THEN  1 ELSE 0 END)  AS UPDATE_TOTAL,
SUM(CASE WHEN A.IUD_FLAG='D' THEN  1 ELSE 0 END)  AS DEL_TOTAL
  FROM
  DWL_P_BASE_WORK.PGT_FLNA_SLS_CUST_MTRL_SUMMRY_STG A

)TBL3

 WHERE LOWER(DATABASENAME)=LOWER('DWL_P_DRVD') AND
        LOWER(TABLENAME)=LOWER('PGT_FLNA_SLS_CUST_MTRL_SUMMRY')
  
 ) WITH DATA UNIQUE PRIMARY INDEX ( TABLENAME )
ON COMMIT PRESERVE ROWS
;

 *** Table has been created. 
 *** Total elapsed time was 3 seconds.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

INSERT INTO PEPCMN_P_DATA.LD_STATCS 
SELECT * FROM VOL_LD_STATCS WHERE TABLENAME ='PGT_FLNA_SLS_CUST_MTRL_SUMMRY';

 *** Insert completed. One row added. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

 .logoff;
 *** You are now logged off from the DBC.
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
  .quit;
 *** Exiting BTEQ...
 *** RC (return code) = 0 
Return Code 0
Executing collectstats task
DWL_P_DRVD
PGT_FLNA_SLS_CUST_MTRL_SUMMRY
BTEQ 16.20.00.10 (64-bit) Thu Aug  7 06:00:43 2025 PID: 24107
 
+---------+---------+---------+---------+---------+---------+---------+----

 .run file /etlapps/prds2/dwl/intl/bin/dwl_intl_tdlogon.btq
+---------+---------+---------+---------+---------+---------+---------+----
.logon tdprod/DWL_BATCH_INTL_P,

 *** Logon successfully completed.
 *** Teradata Database Release is 17.20.03.16a                  
 *** Teradata Database Version is 17.20.03.16                     
 *** Transaction Semantics are BTET.
 *** Session Character Set Name is 'ASCII'.
 
 *** Total elapsed time was 1 second.
 
+---------+---------+---------+---------+---------+---------+---------+----

 *** Encountered EOF on RUN file. Returning to stdin.
+---------+---------+---------+---------+---------+---------+---------+----
 .IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+----

  .set width 254
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
  .set maxerror 4
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

  SELECT CURRENT_TIMESTAMP(0);

 *** Query completed. One row found. One column returned. 
 *** Total elapsed time was 1 second.

     Current TimeStamp(0)
-------------------------
2025-08-07 06:00:43-05:00

+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

  .IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
  
    SELECT SESSION;

 *** Query completed. One row found. One column returned. 
 *** Total elapsed time was 1 second.

    Session
-----------
  101761661

+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.SET WIDTH 800;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.set titledashes off;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
 .set sidetitles off;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

  
 sel * FROM DWL_P_INTL.STATS_TBL
WHERE DATABASENAME='DWL_P_DRVD' AND TABLENAME='PGT_FLNA_SLS_CUST_MTRL_SUMMRY';

 *** Query completed. No rows found. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.IF ACTIVITYCOUNT <> 0 THEN .GOTO STATS_FROM_TABLE;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.SET ERRORLEVEL 3624 SEVERITY 0
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
COLLECT STATISTICS ON DWL_P_DRVD.PGT_FLNA_SLS_CUST_MTRL_SUMMRY;

 *** Update completed. 4 rows changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
 .IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.GOTO DONE;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.LABEL STATS_FROM_TABLE
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
.EXPORT  FILE = /etlapps/prds2/dwl/intl/tmp/LD_PGT_FLNA_SLS_CUST_MTRL_SUMMRY.DW_PGT_FLNA_SLS_CUST_MTRL_SUMMRY_LOAD.DWL_P_DRVD.PGT_FLNA_SLS_CUST_MTRL_SUMMRY.txt
 *** Skipped.
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-


SEL CASE WHEN FLG_TYPE='I'
 THEN 
 'INDEX( '||COLUMNNAME||')'||' '||COALESCE(STATS_NM,'')||','
 WHEN FLG_TYPE='C'
 THEN 
'COLUMN('||COLUMNNAME||')'  ||' '||COALESCE(STATS_NM,'')||',' 
WHEN FLG_TYPE='NI'
 THEN 
 'INDEX  '||COLUMNNAME||''||' '||COALESCE(STATS_NM,'')||','
END  (TITLE '') FROM DWL_P_INTL.STATS_TBL
WHERE DATABASENAME='DWL_P_DRVD' AND TABLENAME='PGT_FLNA_SLS_CUST_MTRL_SUMMRY';
 *** Skipped.
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.EXPORT RESET;
 *** Skipped.
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-


.OS sed -i '$ s/,$//' /etlapps/prds2/dwl/intl/tmp/LD_PGT_FLNA_SLS_CUST_MTRL_SUMMRY.DW_PGT_FLNA_SLS_CUST_MTRL_SUMMRY_LOAD.DWL_P_DRVD.PGT_FLNA_SLS_CUST_MTRL_SUMMRY.txt
 *** Skipped.
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.OS sed -i '1i collect stats ' /etlapps/prds2/dwl/intl/tmp/LD_PGT_FLNA_SLS_CUST_MTRL_SUMMRY.DW_PGT_FLNA_SLS_CUST_MTRL_SUMMRY_LOAD.DWL_P_DRVD.PGT_FLNA_SLS_CUST_MTRL_SUMMRY.txt
 *** Skipped.
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-


.OS echo " on  DWL_P_DRVD.PGT_FLNA_SLS_CUST_MTRL_SUMMRY;">>/etlapps/prds2/dwl/intl/tmp/LD_PGT_FLNA_SLS_CUST_MTRL_SUMMRY.DW_PGT_FLNA_SLS_CUST_MTRL_SUMMRY_LOAD.DWL_P_DRVD.PGT_FLNA_SLS_CUST_MTRL_SUMMRY.txt
 *** Skipped.
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.RUN FILE /etlapps/prds2/dwl/intl/tmp/LD_PGT_FLNA_SLS_CUST_MTRL_SUMMRY.DW_PGT_FLNA_SLS_CUST_MTRL_SUMMRY_LOAD.DWL_P_DRVD.PGT_FLNA_SLS_CUST_MTRL_SUMMRY.txt
 *** Skipped.
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
 *** Skipped.
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

.LABEL DONE
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
SELECT CURRENT_TIMESTAMP(0);

 *** Query completed. One row found. One column returned. 
 *** Total elapsed time was 1 second.

     Current TimeStamp(0)
2025-08-07 06:00:44-05:00

+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
 .logoff;
 *** You are now logged off from the DBC.
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
  .quit;
 *** Exiting BTEQ...
 *** RC (return code) = 0 
Return Code 0
BTEQ 16.20.00.10 (64-bit) Thu Aug  7 06:00:44 2025 PID: 26240
 
+---------+---------+---------+---------+---------+---------+---------+----

  .run file /etlapps/prds2/dwl/intl/bin/dwl_intl_tdlogon.btq
+---------+---------+---------+---------+---------+---------+---------+----
.logon tdprod/DWL_BATCH_INTL_P,

 *** Logon successfully completed.
 *** Teradata Database Release is 17.20.03.16a                  
 *** Teradata Database Version is 17.20.03.16                     
 *** Transaction Semantics are BTET.
 *** Session Character Set Name is 'ASCII'.
 
 *** Total elapsed time was 15 seconds.
 
+---------+---------+---------+---------+---------+---------+---------+----

 *** Encountered EOF on RUN file. Returning to stdin.
+---------+---------+---------+---------+---------+---------+---------+----
  .IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+----

  .set width 254
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
  .set maxerror 4
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

  SELECT CURRENT_TIMESTAMP(0);

 *** Query completed. One row found. One column returned. 
 *** Total elapsed time was 1 second.

     Current TimeStamp(0)
-------------------------
2025-08-07 06:00:59-05:00

+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-
  
  EXEC PEPCMN_P.STEP_END('DWL', 'LD_PGT_FLNA_SLS_CUST_MTRL_SUMMRY', 'DW_PGT_FLNA_SLS_CUST_MTRL_SUMMRY_LOAD');

 *** Update completed. One row changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

  .IF ERRORLEVEL <> 0 THEN .QUIT ERRORLEVEL;
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

  .logoff;
 *** You are now logged off from the DBC.
+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+---------+-

  .quit;
 *** Exiting BTEQ...
 *** RC (return code) = 0 
Return Code 0
